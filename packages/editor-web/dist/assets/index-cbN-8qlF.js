import{r as me,d as Be,g as Re,b as k,u as Me,e as He,R as V,N as ge,B as Ue,f as qe,h as te}from"./vendor-CAp4Hrcn.js";import{I as se,G as K,R as P,T as F,L as ne,a as oe,S as Ve,E as Ge,C as Xe,b as Ke,c as Ye,d as Ze}from"./konva-CVeCxRDN.js";(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const h of document.querySelectorAll('link[rel="modulepreload"]'))r(h);new MutationObserver(h=>{for(const a of h)if(a.type==="childList")for(const n of a.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&r(n)}).observe(document,{childList:!0,subtree:!0});function s(h){const a={};return h.integrity&&(a.integrity=h.integrity),h.referrerPolicy&&(a.referrerPolicy=h.referrerPolicy),h.crossOrigin==="use-credentials"?a.credentials="include":h.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function r(h){if(h.ep)return;h.ep=!0;const a=s(h);fetch(h.href,a)}})();var ce={exports:{}},re={};var je;function Je(){if(je)return re;je=1;var t=me(),o=Symbol.for("react.element"),s=Symbol.for("react.fragment"),r=Object.prototype.hasOwnProperty,h=t.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,a={key:!0,ref:!0,__self:!0,__source:!0};function n(c,i,l){var p,x={},m=null,g=null;l!==void 0&&(m=""+l),i.key!==void 0&&(m=""+i.key),i.ref!==void 0&&(g=i.ref);for(p in i)r.call(i,p)&&!a.hasOwnProperty(p)&&(x[p]=i[p]);if(c&&c.defaultProps)for(p in i=c.defaultProps,i)x[p]===void 0&&(x[p]=i[p]);return{$$typeof:o,type:c,key:m,ref:g,props:x,_owner:h.current}}return re.Fragment=s,re.jsx=n,re.jsxs=n,re}var ve;function Qe(){return ve||(ve=1,ce.exports=Je()),ce.exports}var e=Qe(),ae={},ye;function et(){if(ye)return ae;ye=1;var t=Be();return ae.createRoot=t.createRoot,ae.hydrateRoot=t.hydrateRoot,ae}var tt=et();const rt=Re(tt);var nt={xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"};const st=t=>t.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase(),it=(t,o)=>{const s=k.forwardRef(({color:r="currentColor",size:h=24,strokeWidth:a=2,absoluteStrokeWidth:n,children:c,...i},l)=>k.createElement("svg",{ref:l,...nt,width:h,height:h,stroke:r,strokeWidth:n?Number(a)*24/Number(h):a,className:`lucide lucide-${st(t)}`,...i},[...o.map(([p,x])=>k.createElement(p,x)),...(Array.isArray(c)?c:[c])||[]]));return s.displayName=`${t}`,s};var L=it;const Le=L("AlertCircle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["line",{x1:"12",x2:"12",y1:"8",y2:"12",key:"1pkeuh"}],["line",{x1:"12",x2:"12.01",y1:"16",y2:"16",key:"4dfq90"}]]),ot=L("Check",[["polyline",{points:"20 6 9 17 4 12",key:"10jjfj"}]]),at=L("Cloud",[["path",{d:"M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z",key:"p7xjir"}]]),le=L("FolderOpen",[["path",{d:"m6 14 1.45-2.9A2 2 0 0 1 9.24 10H20a2 2 0 0 1 1.94 2.5l-1.55 6a2 2 0 0 1-1.94 1.5H4a2 2 0 0 1-2-2V5c0-1.1.9-2 2-2h3.93a2 2 0 0 1 1.66.9l.82 1.2a2 2 0 0 0 1.66.9H18a2 2 0 0 1 2 2v2",key:"1nmvlm"}]]),lt=L("Grid",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",ry:"2",key:"1m3agn"}],["line",{x1:"3",x2:"21",y1:"9",y2:"9",key:"1vqk6q"}],["line",{x1:"3",x2:"21",y1:"15",y2:"15",key:"o2sbyz"}],["line",{x1:"9",x2:"9",y1:"3",y2:"21",key:"13tij5"}],["line",{x1:"15",x2:"15",y1:"3",y2:"21",key:"1hpv9i"}]]),ct=L("Image",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",ry:"2",key:"1m3agn"}],["circle",{cx:"9",cy:"9",r:"2",key:"af1f0g"}],["path",{d:"m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21",key:"1xmnt7"}]]),be=L("Key",[["circle",{cx:"7.5",cy:"15.5",r:"5.5",key:"yqb3hr"}],["path",{d:"m21 2-9.6 9.6",key:"1j0ho8"}],["path",{d:"m15.5 7.5 3 3L22 7l-3-3",key:"1rn1fs"}]]),Ae=L("Loader",[["line",{x1:"12",x2:"12",y1:"2",y2:"6",key:"gza1u7"}],["line",{x1:"12",x2:"12",y1:"18",y2:"22",key:"1qhbu9"}],["line",{x1:"4.93",x2:"7.76",y1:"4.93",y2:"7.76",key:"xae44r"}],["line",{x1:"16.24",x2:"19.07",y1:"16.24",y2:"19.07",key:"bxnmvf"}],["line",{x1:"2",x2:"6",y1:"12",y2:"12",key:"89khin"}],["line",{x1:"18",x2:"22",y1:"12",y2:"12",key:"pb8tfm"}],["line",{x1:"4.93",x2:"7.76",y1:"19.07",y2:"16.24",key:"1uxjnu"}],["line",{x1:"16.24",x2:"19.07",y1:"7.76",y2:"4.93",key:"6duxfx"}]]),dt=L("Lock",[["rect",{width:"18",height:"11",x:"3",y:"11",rx:"2",ry:"2",key:"1w4ew1"}],["path",{d:"M7 11V7a5 5 0 0 1 10 0v4",key:"fwvmzm"}]]),ht=L("LogOut",[["path",{d:"M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4",key:"1uf3rs"}],["polyline",{points:"16 17 21 12 16 7",key:"1gabdz"}],["line",{x1:"21",x2:"9",y1:"12",y2:"12",key:"1uyos4"}]]),pt=L("Magnet",[["path",{d:"m6 15-4-4 6.75-6.77a7.79 7.79 0 0 1 11 11L13 22l-4-4 6.39-6.36a2.14 2.14 0 0 0-3-3L6 15",key:"1i3lhw"}],["path",{d:"m5 8 4 4",key:"j6kj7e"}],["path",{d:"m12 15 4 4",key:"lnac28"}]]),ut=L("Menu",[["line",{x1:"4",x2:"20",y1:"12",y2:"12",key:"1e0a9i"}],["line",{x1:"4",x2:"20",y1:"6",y2:"6",key:"1owob3"}],["line",{x1:"4",x2:"20",y1:"18",y2:"18",key:"yk5zj1"}]]),xt=L("MousePointer",[["path",{d:"m3 3 7.07 16.97 2.51-7.39 7.39-2.51L3 3z",key:"y2ucgo"}],["path",{d:"m13 13 6 6",key:"1nhxnf"}]]),ft=L("Play",[["polygon",{points:"5 3 19 12 5 21 5 3",key:"191637"}]]),gt=L("Plus",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"M12 5v14",key:"s699le"}]]),mt=L("Redo2",[["path",{d:"m15 14 5-5-5-5",key:"12vg1m"}],["path",{d:"M20 9H9.5A5.5 5.5 0 0 0 4 14.5v0A5.5 5.5 0 0 0 9.5 20H13",key:"19mnr4"}]]),jt=L("Save",[["path",{d:"M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z",key:"1owoqh"}],["polyline",{points:"17 21 17 13 7 13 7 21",key:"1md35c"}],["polyline",{points:"7 3 7 8 15 8",key:"8nz8an"}]]),vt=L("Search",[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["path",{d:"m21 21-4.3-4.3",key:"1qie3q"}]]),yt=L("Square",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}]]),De=L("Trash2",[["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6",key:"4alrt4"}],["path",{d:"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2",key:"v07s0e"}],["line",{x1:"10",x2:"10",y1:"11",y2:"17",key:"1uufr5"}],["line",{x1:"14",x2:"14",y1:"11",y2:"17",key:"xtxkd"}]]),bt=L("Type",[["polyline",{points:"4 7 4 4 20 4 20 7",key:"1nosan"}],["line",{x1:"9",x2:"15",y1:"20",y2:"20",key:"swin9y"}],["line",{x1:"12",x2:"12",y1:"4",y2:"20",key:"1tx1rr"}]]),kt=L("Undo2",[["path",{d:"M9 14 4 9l5-5",key:"102s5s"}],["path",{d:"M4 9h10.5a5.5 5.5 0 0 1 5.5 5.5v0a5.5 5.5 0 0 1-5.5 5.5H11",key:"llx8ln"}]]),St=L("Unlock",[["rect",{width:"18",height:"11",x:"3",y:"11",rx:"2",ry:"2",key:"1w4ew1"}],["path",{d:"M7 11V7a5 5 0 0 1 9.9-1",key:"1mm8w8"}]]),Ct=L("User",[["path",{d:"M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2",key:"975kel"}],["circle",{cx:"12",cy:"7",r:"4",key:"17ys0d"}]]),Nt=L("Video",[["path",{d:"m22 8-6 4 6 4V8Z",key:"50v9me"}],["rect",{width:"14",height:"12",x:"2",y:"6",rx:"2",ry:"2",key:"1rqjg6"}]]),Fe=L("X",[["path",{d:"M18 6 6 18",key:"1bl5f8"}],["path",{d:"m6 6 12 12",key:"d8bk6v"}]]),wt=L("ZoomIn",[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["line",{x1:"21",x2:"16.65",y1:"21",y2:"16.65",key:"13gj7c"}],["line",{x1:"11",x2:"11",y1:"8",y2:"14",key:"1vmskp"}],["line",{x1:"8",x2:"14",y1:"11",y2:"11",key:"durymu"}]]),Et=L("ZoomOut",[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["line",{x1:"21",x2:"16.65",y1:"21",y2:"16.65",key:"13gj7c"}],["line",{x1:"8",x2:"14",y1:"11",y2:"11",key:"durymu"}]]);class Tt{logs=[];MAX_LOGS=100;log(o,s,r){const h={timestamp:new Date().toISOString(),level:o,message:s,details:r};this.logs.push(h),this.logs.length>this.MAX_LOGS&&this.logs.shift(),(o==="error"?console.error:o==="warn"?console.warn:console.log)(`[${o.toUpperCase()}] ${s}`,r||"")}info(o,s){this.log("info",o,s)}warn(o,s){this.log("warn",o,s)}error(o,s){this.log("error",o,s)}getLogs(){return[...this.logs]}clear(){this.logs=[]}export(){return JSON.stringify(this.logs,null,2)}}const D=new Tt;class It{DEBUG_MODE=!0;DEBUG_INACTIVITY_MINUTES=3;baseUrl="";token=null;organizationName=null;plan=null;lastActivity=Date.now();inactivityTimer=null;warningTimer=null;INACTIVITY_TIMEOUT=this.DEBUG_MODE?this.DEBUG_INACTIVITY_MINUTES*60*1e3:1800*1e3;WARNING_TIME=this.DEBUG_MODE?(this.DEBUG_INACTIVITY_MINUTES-2)*60*1e3:1680*1e3;constructor(){this.loadToken(),this.startActivityMonitoring()}loadToken(){const o=sessionStorage.getItem("kiosk_auth_token");if(o)try{const s=JSON.parse(o),r=s.lastActivityTime||Date.now(),h=Date.now()-r;h<this.INACTIVITY_TIMEOUT?(this.token=s.token,this.organizationName=s.organizationName||null,this.plan=s.plan||null,this.lastActivity=Date.now(),this.updateActivityTime(),D.info("Token loaded from sessionStorage",{hasToken:!!this.token,organization:this.organizationName,plan:this.plan,inactiveDuration:Math.round(h/1e3)+"s"})):(D.warn("Session expired due to inactivity",{inactiveDuration:Math.round(h/1e3/60)+" minutes"}),this.clearToken())}catch(s){D.error("Failed to parse stored token",s),this.clearToken()}}saveToken(o,s,r){const h={token:o,organizationName:s,plan:r,lastActivityTime:Date.now(),savedAt:new Date().toISOString()};sessionStorage.setItem("kiosk_auth_token",JSON.stringify(h)),sessionStorage.setItem("kiosk_org_data",JSON.stringify({name:s,plan:r})),this.token=o,this.organizationName=s,this.plan=r,this.lastActivity=Date.now(),D.info("Token saved to sessionStorage",{organization:s,plan:r})}updateActivityTime(){const o=sessionStorage.getItem("kiosk_auth_token");if(o)try{const s=JSON.parse(o);s.lastActivityTime=Date.now(),sessionStorage.setItem("kiosk_auth_token",JSON.stringify(s))}catch(s){D.error("Failed to update activity time",s)}}clearToken(){sessionStorage.removeItem("kiosk_auth_token"),sessionStorage.removeItem("kiosk_org_data"),this.token=null,this.organizationName=null,this.plan=null,D.info("Token cleared from sessionStorage")}isAuthenticated(){return this.token!==null}getToken(){return this.token}getOrganizationData(){return{name:this.organizationName,plan:this.plan}}async loginWithLicense(o){D.info("Attempting login with license key");try{const s=await this.request("/api/auth/license",{method:"POST",body:JSON.stringify({licenseKey:o})});return s.token&&s.license&&(this.saveToken(s.token,s.license.organizationName,s.license.plan),D.info("Login successful",{organization:s.license.organizationName,plan:s.license.plan})),s}catch(s){throw D.error("Login failed",s),s}}async refreshToken(){D.info("Refreshing token");try{const o=await this.request("/api/auth/refresh",{method:"POST",authenticated:!0});return o.token&&o.license&&(this.saveToken(o.token,o.license.organizationName,o.license.plan),D.info("Token refreshed successfully")),o}catch(o){throw D.error("Token refresh failed",o),o}}async verifyToken(){try{return await this.request("/api/auth/verify",{method:"GET",authenticated:!0}),D.info("Token verified successfully"),!0}catch(o){return D.warn("Token verification failed",o),this.clearToken(),!1}}logout(){D.info("User logout"),this.clearToken(),this.stopActivityMonitoring(),window.dispatchEvent(new CustomEvent("auth:logout"))}updateActivity(){this.lastActivity=Date.now(),this.updateActivityTime(),this.resetTimers()}resetTimers(){this.warningTimer&&clearTimeout(this.warningTimer),this.inactivityTimer&&clearTimeout(this.inactivityTimer),this.warningTimer=setTimeout(()=>{D.warn("Inactivity warning - 2 minutes until logout"),window.dispatchEvent(new CustomEvent("auth:inactivity-warning",{detail:{timeRemaining:120*1e3}}))},this.WARNING_TIME),this.inactivityTimer=setTimeout(()=>{D.warn("Session expired due to inactivity"),this.logout()},this.INACTIVITY_TIMEOUT)}startActivityMonitoring(){if(!this.isAuthenticated())return;["mousemove","keypress","click","scroll","touchstart"].forEach(s=>{window.addEventListener(s,()=>this.updateActivity(),{passive:!0})}),this.resetTimers(),D.info("Activity monitoring started",{timeout:this.INACTIVITY_TIMEOUT/1e3/60+" minutes",warning:this.WARNING_TIME/1e3/60+" minutes"})}stopActivityMonitoring(){this.warningTimer&&(clearTimeout(this.warningTimer),this.warningTimer=null),this.inactivityTimer&&(clearTimeout(this.inactivityTimer),this.inactivityTimer=null),D.info("Activity monitoring stopped")}async getProjects(o){const s=new URLSearchParams;o?.search&&s.append("search",o.search),o?.tags&&s.append("tags",o.tags.join(",")),o?.isPublished!==void 0&&s.append("isPublished",String(o.isPublished)),o?.page&&s.append("page",String(o.page)),o?.limit&&s.append("limit",String(o.limit));const r=s.toString(),h=`/api/projects${r?"?"+r:""}`;return this.request(h,{method:"GET",authenticated:!0})}async createProject(o){return(await this.request("/api/projects",{method:"POST",authenticated:!0,body:JSON.stringify(o)})).project}async getProject(o){return(await this.request(`/api/projects/${o}`,{method:"GET",authenticated:!0})).project}async updateProject(o,s){return(await this.request(`/api/projects/${o}`,{method:"PUT",authenticated:!0,body:JSON.stringify(s)})).project}async deleteProject(o){await this.request(`/api/projects/${o}`,{method:"DELETE",authenticated:!0})}async getProjectFiles(o){return(await this.request(`/api/projects/${o}/files`,{method:"GET",authenticated:!0})).files}async uploadFile(o,s,r){const h=new FormData;return h.append("file",s),new Promise((a,n)=>{const c=new XMLHttpRequest;r&&c.upload.addEventListener("progress",i=>{if(i.lengthComputable){const l=i.loaded/i.total*100;r(l)}}),c.addEventListener("load",()=>{if(c.status===200||c.status===201)try{const i=JSON.parse(c.responseText);a(i.file||i)}catch{n(new Error("Failed to parse response"))}else try{const i=JSON.parse(c.responseText);n(new Error(i.message||`Upload failed: ${c.status}`))}catch{n(new Error(`Upload failed: ${c.status}`))}}),c.addEventListener("error",()=>{n(new Error("Network error"))}),c.open("POST",`/api/projects/${o}/files`),this.token&&c.setRequestHeader("Authorization",`Bearer ${this.token}`),c.send(h)})}async downloadFile(o,s){const r=await fetch(`/api/projects/${o}/files/${s}`,{method:"GET",headers:this.token?{Authorization:`Bearer ${this.token}`}:{}});if(!r.ok)throw new Error(`Download failed: ${r.status}`);return r.blob()}async deleteFile(o,s){await this.request(`/api/projects/${o}/files/${s}`,{method:"DELETE",authenticated:!0})}async getStorageStats(){return this.request("/api/storage/stats",{method:"GET",authenticated:!0})}async request(o,s){const r=`${this.baseUrl}${o}`,h={"Content-Type":"application/json"};s.authenticated&&this.token&&(h.Authorization=`Bearer ${this.token}`);try{const a=await fetch(r,{method:s.method,headers:h,body:s.body});if(s.authenticated&&a.ok&&this.updateActivity(),!a.ok){if(a.status===401)throw D.warn("Unauthorized - clearing token"),this.clearToken(),window.dispatchEvent(new CustomEvent("auth:unauthorized")),new Error("Unauthorized");const n=await a.json().catch(()=>({}));throw new Error(n.message||`HTTP ${a.status}`)}return await a.json()}catch(a){throw D.error("Request failed",{endpoint:o,method:s.method,error:a}),a}}}const H=new It,Pt=()=>{const t=Me(),[o,s]=k.useState(""),[r,h]=k.useState(!1),[a,n]=k.useState(null);k.useEffect(()=>{const g=sessionStorage.getItem("kiosk_logout_reason");g==="inactivity"?(i("Вы были автоматически выведены из системы из-за неактивности"),D.info("Logout reason: inactivity")):g==="session_expired"&&(i("Ваша сессия истекла. Пожалуйста, войдите снова"),D.info("Logout reason: session expired")),sessionStorage.removeItem("kiosk_logout_reason"),g&&setTimeout(()=>i(null),5e3)},[]);const[c,i]=k.useState(null),l=g=>(g.replace(/[^A-Z0-9]/gi,"").toUpperCase().match(/.{1,4}/g)||[]).join("-").substring(0,19),p=g=>{const b=l(g.target.value);s(b),n(null)},x=async g=>{if(g.preventDefault(),o.length<19){n("Введите полный ключ лицензии (16 символов)");return}h(!0),n(null);try{console.log("[LoginPage] Attempting login");const b=await H.loginWithLicense(o);console.log("[LoginPage] Login successful, redirecting to /editor"),t("/editor",{replace:!0})}catch(b){console.error("[LoginPage] Login failed:",b),n(b.message||"Не удалось выполнить вход. Проверьте ключ лицензии."),h(!1)}},m=g=>{g.preventDefault();const b=g.clipboardData.getData("text"),v=l(b);s(v)};return e.jsx("div",{className:"login-page",children:e.jsxs("div",{className:"login-container",children:[e.jsxs("div",{className:"login-header",children:[e.jsx(be,{size:48,className:"login-icon"}),e.jsx("h1",{children:"Kiosk Editor"}),e.jsx("p",{children:"Вход в систему"})]}),e.jsxs("form",{onSubmit:x,className:"login-form",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"licenseKey",children:"Ключ лицензии"}),e.jsx("input",{type:"text",id:"licenseKey",placeholder:"XXXX-XXXX-XXXX-XXXX",value:o,onChange:p,onPaste:m,disabled:r,autoFocus:!0,maxLength:19,className:a?"error":""}),e.jsx("span",{className:"input-hint",children:"Формат: 4 группы по 4 символа"})]}),a&&e.jsxs("div",{className:"error-message",children:[e.jsx(Le,{size:16}),e.jsx("span",{children:a})]}),e.jsx("button",{type:"submit",className:"login-button",disabled:r||o.length<19,children:r?e.jsxs(e.Fragment,{children:[e.jsx(Ae,{size:20,className:"spinner"}),e.jsx("span",{children:"Вход..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(be,{size:20}),e.jsx("span",{children:"Войти"})]})})]}),e.jsxs("div",{className:"test-keys",children:[e.jsx("p",{children:"Тестовые ключи:"}),e.jsxs("ul",{children:[e.jsxs("li",{children:[e.jsx("strong",{children:"BASIC:"})," ",e.jsx("code",{children:"EWZA-E5LJ-Z558-9LUQ"})]}),e.jsxs("li",{children:[e.jsx("strong",{children:"PRO:"})," ",e.jsx("code",{children:"3VBN-8ZQ9-1MKO-AK0R"})]}),e.jsxs("li",{children:[e.jsx("strong",{children:"MAX:"})," ",e.jsx("code",{children:"T8MH-FJE3-ETAC-YOZF"})]})]})]})]})})};function ke(t,o,s,r=0){const h=o/2,a=s/2,n=Math.min(o,s)/2,c=(i,l=-Math.PI/2)=>{const p=[];for(let x=0;x<i;x++){const m=l+2*Math.PI*x/i,g=h+n*Math.cos(m),b=a+n*Math.sin(m),v=(g/o*100).toFixed(1),f=(b/s*100).toFixed(1);p.push(`${v}% ${f}%`)}return`polygon(${p.join(", ")})`};switch(t){case"circle":return`circle(${n}px at ${h}px ${a}px)`;case"ellipse":return"ellipse(50% 50% at 50% 50%)";case"triangle":{const i=[],l=[-Math.PI/2,Math.PI/6,5*Math.PI/6];for(const p of l){const x=h+n*Math.cos(p),m=a+n*Math.sin(p);i.push(`${(x/o*100).toFixed(1)}% ${(m/s*100).toFixed(1)}%`)}return`polygon(${i.join(", ")})`}case"diamond":return`polygon(${h/o*100}% 0%, 100% ${a/s*100}%, ${h/o*100}% 100%, 0% ${a/s*100}%)`;case"pentagon":return c(5);case"hexagon":return c(6);case"octagon":return c(8);case"star":{const i=[];for(let l=0;l<10;l++){const p=l*Math.PI/5-Math.PI/2,x=l%2===0?n:n*.5,m=h+x*Math.cos(p),g=a+x*Math.sin(p);i.push(`${(m/o*100).toFixed(1)}% ${(g/s*100).toFixed(1)}%`)}return`polygon(${i.join(", ")})`}default:return}}const zt=({widgetId:t,commonStyle:o,items:s,isHorizontal:r,backgroundColor:h,textColor:a,hoverColor:n,fontSize:c,fontFamily:i,itemPadding:l,itemHeight:p,submenuBackgroundColor:x,submenuTextColor:m,borderWidth:g,borderColor:b,executeActions:v})=>{const[f,u]=k.useState(null),[N,S]=k.useState(null),C={...o,backgroundColor:h,display:"flex",flexDirection:r?"row":"column",border:g>0?`${g}px solid ${b}`:"none",overflow:"visible",position:"absolute"},I=d=>({display:"flex",alignItems:"center",padding:`0 ${l}px`,height:`${p}px`,minWidth:r?"auto":"100%",color:f===d?m:a,backgroundColor:f===d?n:"transparent",fontSize:`${c}px`,fontFamily:i,cursor:"pointer",userSelect:"none",whiteSpace:"nowrap",transition:"background-color 0.15s",position:"relative",boxSizing:"border-box"}),T=d=>({display:N===d?"flex":"none",flexDirection:"column",position:"absolute",top:r?`${p}px`:"0",left:r?"0":"100%",backgroundColor:x,zIndex:9999,minWidth:"150px",boxShadow:"2px 4px 12px rgba(0,0,0,0.4)"});return e.jsx("div",{"data-widget-id":t,style:C,children:s.map(d=>{const y=d.children&&d.children.length>0;return e.jsxs("div",{style:{position:"relative"},onMouseEnter:()=>{u(d.id),y&&S(d.id)},onMouseLeave:()=>{u(null),y&&S(null)},children:[e.jsxs("div",{style:I(d.id),onClick:()=>{d.actions&&d.actions.length>0&&v(d.actions)},children:[d.label,y&&e.jsx("span",{style:{marginLeft:"6px",fontSize:"10px",opacity:.7},children:r?"▼":"▶"})]}),y&&e.jsx("div",{style:T(d.id),children:d.children.map(j=>e.jsx("div",{style:{padding:`0 ${l}px`,height:`${p}px`,display:"flex",alignItems:"center",color:f===j.id?a:m,backgroundColor:f===j.id?n:"transparent",fontSize:`${c-2}px`,fontFamily:i,cursor:"pointer",userSelect:"none",whiteSpace:"nowrap",transition:"background-color 0.15s"},onMouseEnter:()=>u(j.id),onMouseLeave:()=>u(null),onClick:()=>{j.actions&&j.actions.length>0&&v(j.actions)},children:j.label},j.id))})]},d.id)})})},Wt=()=>{const[t]=He(),o=t.get("projectId"),[s,r]=k.useState(null),[h,a]=k.useState(!0),[n,c]=k.useState(null),[i,l]=k.useState(!1),[p,x]=k.useState(null),[m,g]=k.useState(new Set);k.useEffect(()=>{if(!o){c("Project ID not provided"),a(!1);return}(async()=>{try{const u=await H.getProject(o),N={id:u.id,version:"1.0",name:u.name,canvas:{width:u.canvasWidth,height:u.canvasHeight,backgroundColor:u.canvasBackground},widgets:u.projectData?.widgets||[]};r(N)}catch(u){c(u.message||"Failed to load project")}finally{a(!1)}})()},[o]),k.useEffect(()=>{const f=u=>{u.key==="Escape"&&(i?l(!1):window.close())};return document.documentElement.requestFullscreen?.().catch(()=>{}),window.addEventListener("keydown",f),()=>window.removeEventListener("keydown",f)},[i]);const b=f=>{f.forEach(u=>{switch(u.type){case"url":u.url&&(u.openInNewTab?window.open(u.url,"_blank"):window.location.href=u.url);break;case"popup":x({title:u.popupTitle||"Информация",content:u.popupContent||"",width:u.popupWidth||400,height:u.popupHeight||300}),l(!0);break;case"widget_show":u.targetWidgetId&&g(N=>{const S=new Set(N);return S.delete(u.targetWidgetId),S});break;case"widget_hide":u.targetWidgetId&&g(N=>new Set(N).add(u.targetWidgetId));break;case"video_play":if(u.targetWidgetId){const N=document.querySelector(`[data-widget-id="${u.targetWidgetId}"] video`);N&&N.play()}break;case"video_stop":if(u.targetWidgetId){const N=document.querySelector(`[data-widget-id="${u.targetWidgetId}"] video`);N&&(N.pause(),N.currentTime=0)}break}})},v=f=>{if(m.has(f.id))return null;const u=f.events,N=()=>{u&&u.filter(C=>C.trigger==="click").forEach(C=>b(C.actions))},S={position:"absolute",left:f.x,top:f.y,width:f.width,height:f.height,transform:f.rotation?`rotate(${f.rotation}deg)`:void 0,cursor:u&&u.some(C=>C.trigger==="click")?"pointer":"default",zIndex:f.zIndex||0};if(f.type==="shape"){const{shapeType:C="rectangle",fillColor:I="#4a90e2",strokeColor:T="#000000",strokeWidth:d=0,cornerRadius:y=0,opacity:j=1}=f.properties,E=ke(C,f.width,f.height,y),M=E!==void 0,_=C==="circle"?"50%":C==="rounded-rectangle"||C==="rectangle"?`${y}px`:void 0;return e.jsx("div",{"data-widget-id":f.id,style:{...S,border:d>0?`${d}px solid ${T}`:"none",borderRadius:_,opacity:j,overflow:"hidden"},onClick:N,children:e.jsx("div",{style:{width:"100%",height:"100%",backgroundColor:I,borderRadius:_,clipPath:M?E:void 0,WebkitClipPath:M?E:void 0}})},f.id)}if(f.type==="text"){const{text:C="Text",fontSize:I=24,color:T="#000000",fontFamily:d="Arial",fontWeight:y="normal",textAlign:j="left",verticalAlign:E="top",backgroundColor:M="transparent"}=f.properties;return e.jsx("div",{"data-widget-id":f.id,style:{...S,fontSize:`${I}px`,color:T,fontFamily:d,fontWeight:y,backgroundColor:M,textAlign:j,display:"flex",alignItems:E==="middle"?"center":E==="bottom"?"flex-end":"flex-start",whiteSpace:"pre-wrap",wordWrap:"break-word"},onClick:N,children:C},f.id)}if(f.type==="image"){const{src:C="",objectFit:I="contain",opacity:T=1,clipShape:d="rectangle",cornerRadius:y=0}=f.properties;if(!C)return null;const j=ke(d,f.width,f.height,y);return e.jsx("div",{"data-widget-id":f.id,style:{...S,opacity:T,borderRadius:d==="rounded-rectangle"&&y?`${y}px`:void 0,overflow:"hidden",clipPath:j,WebkitClipPath:j},onClick:N,children:e.jsx("img",{src:C,alt:"",style:{width:"100%",height:"100%",objectFit:I}})},f.id)}if(f.type==="video"){const{src:C="",autoplay:I=!1,loop:T=!1,muted:d=!0,objectFit:y="contain"}=f.properties;return C?e.jsx("div",{"data-widget-id":f.id,style:S,onClick:N,children:e.jsx("video",{src:C,autoPlay:I,loop:T,muted:d,style:{width:"100%",height:"100%",objectFit:y}})},f.id):null}if(f.type==="button"){const{text:C="Button",backgroundColor:I="#4a90e2",textColor:T="#ffffff",fontSize:d=16,borderRadius:y=4}=f.properties;return e.jsx("div",{"data-widget-id":f.id,style:{...S,backgroundColor:I,color:T,fontSize:`${d}px`,borderRadius:`${y}px`,display:"flex",alignItems:"center",justifyContent:"center",border:"none",cursor:"pointer",userSelect:"none"},onClick:N,children:C},f.id)}if(f.type==="menu"){const{items:C=[],orientation:I="horizontal",backgroundColor:T="#2c3e50",textColor:d="#ffffff",hoverColor:y="#34495e",fontSize:j=16,fontFamily:E="Arial",itemPadding:M=16,itemHeight:_=40,submenuBackgroundColor:A="#34495e",submenuTextColor:R="#ffffff",borderWidth:W=0,borderColor:w="#000000"}=f.properties;return e.jsx(zt,{widgetId:f.id,commonStyle:S,items:C,isHorizontal:I==="horizontal",backgroundColor:T,textColor:d,hoverColor:y,fontSize:j,fontFamily:E,itemPadding:M,itemHeight:_,submenuBackgroundColor:A,submenuTextColor:R,borderWidth:W,borderColor:w,executeActions:b},f.id)}return null};return h?e.jsx("div",{className:"preview-page preview-loading",children:e.jsx("div",{className:"loading-spinner"})}):n||!s?e.jsx("div",{className:"preview-page preview-error",children:e.jsx("p",{children:n||"Проект не найден"})}):e.jsxs("div",{className:"preview-page",children:[e.jsx("div",{className:"preview-canvas",style:{width:s.canvas.width,height:s.canvas.height,backgroundColor:s.canvas.backgroundColor||"#ffffff",position:"relative"},children:s.widgets.slice().sort((f,u)=>(f.zIndex||0)-(u.zIndex||0)).map(f=>v(f))}),i&&p&&e.jsx("div",{className:"preview-popup-overlay",onClick:()=>l(!1),children:e.jsxs("div",{className:"preview-popup",style:{width:p.width,maxHeight:p.height},onClick:f=>f.stopPropagation(),children:[e.jsxs("div",{className:"preview-popup-header",children:[e.jsx("h3",{children:p.title}),e.jsx("button",{onClick:()=>l(!1),children:"×"})]}),e.jsx("div",{className:"preview-popup-content",children:p.content})]})})]})},Rt=()=>{const[t,o]=k.useState(!1),[s,r]=k.useState(120);if(k.useEffect(()=>{const n=()=>{o(!0),r(120)},c=()=>{o(!1)},i=()=>{t&&o(!1)};window.addEventListener("auth:inactivity-warning",n),window.addEventListener("auth:logout",c);const l=["mousemove","keypress","click","scroll","touchstart"];return l.forEach(p=>{window.addEventListener(p,i)}),()=>{window.removeEventListener("auth:inactivity-warning",n),window.removeEventListener("auth:logout",c),l.forEach(p=>{window.removeEventListener(p,i)})}},[t]),k.useEffect(()=>{if(!t)return;const n=setInterval(()=>{r(c=>c<=1?(o(!1),0):c-1)},1e3);return()=>clearInterval(n)},[t]),!t)return null;const h=Math.floor(s/60),a=s%60;return e.jsx("div",{className:"inactivity-warning-overlay",children:e.jsxs("div",{className:"inactivity-warning",children:[e.jsx("div",{className:"warning-icon",children:"⏱️"}),e.jsx("h3",{children:"Сессия скоро истечёт"}),e.jsxs("p",{children:["Вы будете автоматически выведены из системы через"," ",e.jsxs("strong",{children:[h,":",a.toString().padStart(2,"0")]})]}),e.jsx("p",{className:"hint",children:"Нажмите любую клавишу или кликните мышью, чтобы продолжить работу"}),e.jsx("button",{className:"continue-btn",onClick:()=>o(!1),children:"Продолжить работу"})]})})},Mt={},Se=t=>{let o;const s=new Set,r=(p,x)=>{const m=typeof p=="function"?p(o):p;if(!Object.is(m,o)){const g=o;o=x??(typeof m!="object"||m===null)?m:Object.assign({},o,m),s.forEach(b=>b(o,g))}},h=()=>o,i={setState:r,getState:h,getInitialState:()=>l,subscribe:p=>(s.add(p),()=>s.delete(p)),destroy:()=>{(Mt?"production":void 0)!=="production"&&console.warn("[DEPRECATED] The `destroy` method will be unsupported in a future version. Instead use unsubscribe function returned by subscribe. Everything will be garbage-collected if store is garbage-collected."),s.clear()}},l=o=t(r,h,i);return i},Lt=t=>t?Se(t):Se;var de={exports:{}},he={},pe={exports:{}},ue={};var Ce;function At(){if(Ce)return ue;Ce=1;var t=me();function o(x,m){return x===m&&(x!==0||1/x===1/m)||x!==x&&m!==m}var s=typeof Object.is=="function"?Object.is:o,r=t.useState,h=t.useEffect,a=t.useLayoutEffect,n=t.useDebugValue;function c(x,m){var g=m(),b=r({inst:{value:g,getSnapshot:m}}),v=b[0].inst,f=b[1];return a(function(){v.value=g,v.getSnapshot=m,i(v)&&f({inst:v})},[x,g,m]),h(function(){return i(v)&&f({inst:v}),x(function(){i(v)&&f({inst:v})})},[x]),n(g),g}function i(x){var m=x.getSnapshot;x=x.value;try{var g=m();return!s(x,g)}catch{return!0}}function l(x,m){return m()}var p=typeof window>"u"||typeof window.document>"u"||typeof window.document.createElement>"u"?l:c;return ue.useSyncExternalStore=t.useSyncExternalStore!==void 0?t.useSyncExternalStore:p,ue}var Ne;function Dt(){return Ne||(Ne=1,pe.exports=At()),pe.exports}var we;function Ft(){if(we)return he;we=1;var t=me(),o=Dt();function s(l,p){return l===p&&(l!==0||1/l===1/p)||l!==l&&p!==p}var r=typeof Object.is=="function"?Object.is:s,h=o.useSyncExternalStore,a=t.useRef,n=t.useEffect,c=t.useMemo,i=t.useDebugValue;return he.useSyncExternalStoreWithSelector=function(l,p,x,m,g){var b=a(null);if(b.current===null){var v={hasValue:!1,value:null};b.current=v}else v=b.current;b=c(function(){function u(T){if(!N){if(N=!0,S=T,T=m(T),g!==void 0&&v.hasValue){var d=v.value;if(g(d,T))return C=d}return C=T}if(d=C,r(S,T))return d;var y=m(T);return g!==void 0&&g(d,y)?(S=T,d):(S=T,C=y)}var N=!1,S,C,I=x===void 0?null:x;return[function(){return u(p())},I===null?void 0:function(){return u(I())}]},[p,x,m,g]);var f=h(l,b[0],b[1]);return n(function(){v.hasValue=!0,v.value=f},[f]),i(f),f},he}var Ee;function _t(){return Ee||(Ee=1,de.exports=Ft()),de.exports}var $t=_t();const Ot=Re($t),_e={},{useDebugValue:Bt}=V,{useSyncExternalStoreWithSelector:Ht}=Ot;let Te=!1;const Ut=t=>t;function qt(t,o=Ut,s){(_e?"production":void 0)!=="production"&&s&&!Te&&(console.warn("[DEPRECATED] Use `createWithEqualityFn` instead of `create` or use `useStoreWithEqualityFn` instead of `useStore`. They can be imported from 'zustand/traditional'. https://github.com/pmndrs/zustand/discussions/1937"),Te=!0);const r=Ht(t.subscribe,t.getState,t.getServerState||t.getInitialState,o,s);return Bt(r),r}const Ie=t=>{(_e?"production":void 0)!=="production"&&typeof t!="function"&&console.warn("[DEPRECATED] Passing a vanilla store will be unsupported in a future version. Instead use `import { useStore } from 'zustand'`.");const o=typeof t=="function"?Lt(t):t,s=(r,h)=>qt(o,r,h);return Object.assign(s,o),s},Vt=t=>t?Ie(t):Ie;let ee=null;function G(t,o=18e4){ee&&clearTimeout(ee),ee=setTimeout(async()=>{try{console.log("[Editor] Auto-saving project..."),await t(),console.log("[Editor] Auto-save completed")}catch(s){console.error("[Editor] Auto-save failed:",s)}},o)}function $e(){ee&&(clearTimeout(ee),ee=null)}function xe(t){t?(sessionStorage.setItem("kiosk_current_project_id",t),console.log("[Editor] Current project ID saved:",t)):(sessionStorage.removeItem("kiosk_current_project_id"),console.log("[Editor] Current project ID cleared"))}function Gt(){const t=sessionStorage.getItem("kiosk_current_project_id");return t&&console.log("[Editor] Restoring project ID:",t),t}const U=Vt((t,o)=>({project:{version:"1.0.0",name:"Новый проект",canvas:{width:1920,height:1080,backgroundColor:"#1a1a1a"},widgets:[],metadata:{createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()}},projectId:null,isLoading:!1,isSaving:!1,lastSaved:null,saveError:null,selectedWidgetIds:[],clipboard:[],history:{past:[],future:[]},zoom:1,gridEnabled:!0,snapToGrid:!0,gridSize:20,gridLineWidth:1,gridColor:"#e0e0e0",pendingWidget:null,restoreProject:async()=>{const s=Gt();if(s)try{return console.log("[Editor] Restoring last opened project:",s),await o().loadProject(s),!0}catch(r){return console.error("[Editor] Failed to restore project:",r),xe(null),!1}return!1},createProject:async(s,r)=>{t({isLoading:!0,saveError:null});try{const h={version:"1.0",name:s,canvas:r,widgets:[],metadata:{createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()}},a=await H.createProject({name:s,canvasWidth:r.width,canvasHeight:r.height,canvasBackground:r.backgroundColor||"#1a1a1a",projectData:h});t({project:{...h,id:a.id},projectId:a.id,isLoading:!1,lastSaved:new Date,history:{past:[],future:[]}}),console.log("[Editor] Project created:",a.id),xe(a.id),G(o().saveProject)}catch(h){throw console.error("[Editor] Failed to create project:",h),t({isLoading:!1,saveError:h.message||"Failed to create project"}),h}},loadProject:async s=>{t({isLoading:!0,saveError:null});try{const r=await H.getProject(s),h={id:r.id,version:"1.0",name:r.name,canvas:{width:r.canvasWidth,height:r.canvasHeight,backgroundColor:r.canvasBackground},widgets:r.projectData?.widgets||[],metadata:{createdAt:r.createdAt,updatedAt:r.updatedAt}};t({project:h,projectId:r.id,isLoading:!1,lastSaved:new Date(r.updatedAt),history:{past:[],future:[]}}),console.log("[Editor] Project loaded:",s),xe(s),G(o().saveProject)}catch(r){throw console.error("[Editor] Failed to load project:",r),t({isLoading:!1,saveError:r.message||"Failed to load project"}),r}},saveProject:async()=>{const{project:s,projectId:r,isSaving:h}=o();if(!s||!r){console.warn("[Editor] No project to save");return}if(h){console.warn("[Editor] Save already in progress");return}t({isSaving:!0,saveError:null});try{await H.updateProject(r,{name:s.name,projectData:s,canvasWidth:s.canvas.width,canvasHeight:s.canvas.height,canvasBackground:s.canvas.backgroundColor}),t({isSaving:!1,lastSaved:new Date,saveError:null}),console.log("[Editor] Project saved:",r)}catch(a){throw console.error("[Editor] Failed to save project:",a),t({isSaving:!1,saveError:a.message||"Failed to save project"}),a}},deleteProject:async s=>{try{await H.deleteProject(s),o().projectId===s&&(t({project:{version:"1.0.0",name:"Новый проект",canvas:{width:1920,height:1080,backgroundColor:"#1a1a1a"},widgets:[],metadata:{createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()}},projectId:null,selectedWidgetIds:[],history:{past:[],future:[]}}),$e()),console.log("[Editor] Project deleted:",s)}catch(r){throw console.error("[Editor] Failed to delete project:",r),r}},savePreviewSnapshot:async()=>{const{project:s}=o();if(!s)throw new Error("No project to preview");console.log("[Editor] Creating preview snapshot...");try{const r=`_preview_${s.name}_${Date.now()}`,h=await H.createProject({name:r,canvasWidth:s.canvas.width,canvasHeight:s.canvas.height,canvasBackground:s.canvas.backgroundColor||"#1a1a1a",projectData:s});return console.log("[Editor] Preview snapshot created:",h.id),h.id}catch(r){throw console.error("[Editor] Failed to create preview snapshot:",r),r}},updateProjectMetadata:s=>{const{project:r}=o();r&&(t({project:{...r,...s,metadata:{...r.metadata,updatedAt:new Date().toISOString()}}}),G(o().saveProject))},addWidget:s=>{const{project:r}=o();r&&(o().saveToHistory(),t({project:{...r,widgets:[...r.widgets,s],metadata:{...r.metadata,updatedAt:new Date().toISOString()}}}),G(o().saveProject))},setPendingWidget:(s,r)=>{t({pendingWidget:{type:s,defaultProps:r}})},clearPendingWidget:()=>{t({pendingWidget:null})},addWidgetAtPosition:(s,r)=>{const{pendingWidget:h,project:a,snapToGrid:n,gridSize:c}=o();if(!h||!a)return;let i=s,l=r;n&&(i=Math.round(s/c)*c,l=Math.round(r/c)*c);const x={shape:{width:200,height:200},button:{width:200,height:60},text:{width:300,height:100},image:{width:300,height:200},video:{width:640,height:360},menu:{width:600,height:40}}[h.type]||{width:200,height:100},m=h.defaultProps.width||x.width,g=h.defaultProps.height||x.height;i=i-m/2,l=l-g/2;const{width:b,height:v,...f}=h.defaultProps,u={id:`widget-${Date.now()}-${Math.random()}`,type:h.type,x:Math.max(0,i),y:Math.max(0,l),width:m,height:g,zIndex:0,properties:f};o().addWidget(u),o().clearPendingWidget()},updateWidget:(s,r)=>{const{project:h}=o();h&&(t({project:{...h,widgets:h.widgets.map(a=>a.id===s?{...a,...r}:a),metadata:{...h.metadata,updatedAt:new Date().toISOString()}}}),G(o().saveProject))},deleteWidget:s=>{const{project:r}=o();r&&(o().saveToHistory(),t({project:{...r,widgets:r.widgets.filter(h=>h.id!==s),metadata:{...r.metadata,updatedAt:new Date().toISOString()}},selectedWidgetIds:o().selectedWidgetIds.filter(h=>h!==s)}),G(o().saveProject))},duplicateWidget:s=>{const{project:r}=o();if(!r)return;const h=r.widgets.find(n=>n.id===s);if(!h)return;const a={...h,id:`widget-${Date.now()}`,x:h.x+20,y:h.y+20};o().addWidget(a)},selectWidget:(s,r=!1)=>{const{selectedWidgetIds:h}=o();r?h.includes(s)?t({selectedWidgetIds:h.filter(a=>a!==s)}):t({selectedWidgetIds:[...h,s]}):t({selectedWidgetIds:[s]})},clearSelection:()=>{t({selectedWidgetIds:[]})},saveToHistory:()=>{const{project:s,history:r}=o();s&&t({history:{past:[...r.past,s],future:[]}})},undo:()=>{const{history:s,project:r}=o();if(s.past.length===0||!r)return;const h=s.past[s.past.length-1],a=s.past.slice(0,-1);t({project:h,history:{past:a,future:[r,...s.future]}}),G(o().saveProject)},redo:()=>{const{history:s,project:r}=o();if(s.future.length===0||!r)return;const h=s.future[0],a=s.future.slice(1);t({project:h,history:{past:[...s.past,r],future:a}}),G(o().saveProject)},copy:()=>{const{project:s,selectedWidgetIds:r}=o();if(!s)return;const h=s.widgets.filter(a=>r.includes(a.id));t({clipboard:h})},paste:()=>{const{clipboard:s,project:r}=o();if(!r||s.length===0)return;const h=s.map(a=>({...a,id:`widget-${Date.now()}-${Math.random()}`,x:a.x+20,y:a.y+20}));o().saveToHistory(),t({project:{...r,widgets:[...r.widgets,...h]},selectedWidgetIds:h.map(a=>a.id)}),G(o().saveProject)},cut:()=>{const{selectedWidgetIds:s}=o();o().copy(),s.forEach(r=>o().deleteWidget(r))},setZoom:s=>{t({zoom:Math.max(.1,Math.min(5,s))})},toggleGrid:()=>{t(s=>({gridEnabled:!s.gridEnabled}))},toggleSnapToGrid:()=>{t(s=>({snapToGrid:!s.snapToGrid}))},setGridSize:s=>{t({gridSize:Math.max(5,Math.min(100,s))})}}));typeof window<"u"&&window.addEventListener("beforeunload",()=>{$e()});const Xt=()=>{const{isSaving:t,lastSaved:o,saveError:s}=U(),h=s?"error":t?"saving":o?"saved":"idle",a=c=>{const l=new Date().getTime()-c.getTime(),p=Math.floor(l/1e3),x=Math.floor(p/60);return p<10?"Только что":p<60?`${p} сек назад`:x===1?"1 мин назад":x<60?`${x} мин назад`:c.toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"})},n=()=>{switch(h){case"saving":return e.jsxs(e.Fragment,{children:[e.jsx(Ae,{size:16,className:"spinner"}),e.jsx("span",{children:"Сохранение..."})]});case"saved":return e.jsxs(e.Fragment,{children:[e.jsx(ot,{size:16}),e.jsxs("span",{children:["Сохранено ",o&&a(o)]})]});case"error":return e.jsxs(e.Fragment,{children:[e.jsx(Le,{size:16}),e.jsx("span",{title:s||void 0,children:"Ошибка сохранения"})]});default:return e.jsxs(e.Fragment,{children:[e.jsx(at,{size:16}),e.jsx("span",{children:"Не сохранено"})]})}};return e.jsx("div",{className:`autosave-indicator status-${h}`,children:n()})},Kt=({onClose:t,onSuccess:o})=>{const[s,r]=k.useState(""),[h,a]=k.useState(""),[n,c]=k.useState(1920),[i,l]=k.useState(1080),[p,x]=k.useState(!1),{createProject:m}=U(),g=async v=>{if(v.preventDefault(),!s.trim()){alert("Введите название проекта");return}try{x(!0),console.log("[CreateProjectDialog] Creating project:",s),await m(s.trim(),{width:n,height:i,backgroundColor:"#ffffff"}),console.log("[CreateProjectDialog] Project created successfully"),o?.(),t()}catch(f){console.error("[CreateProjectDialog] Failed to create project:",f),alert("Не удалось создать проект")}finally{x(!1)}},b=[{name:"Full HD (горизонтально)",width:1920,height:1080},{name:"Full HD (вертикально)",width:1080,height:1920},{name:"4K (горизонтально)",width:3840,height:2160},{name:"HD (горизонтально)",width:1280,height:720}];return e.jsx("div",{className:"dialog-overlay",onClick:t,children:e.jsxs("div",{className:"dialog-content create-project-dialog",onClick:v=>v.stopPropagation(),children:[e.jsxs("div",{className:"dialog-header",children:[e.jsx("h2",{children:"Создать новый проект"}),e.jsx("button",{className:"btn-icon",onClick:t,title:"Закрыть",children:e.jsx(Fe,{size:24})})]}),e.jsxs("form",{onSubmit:g,children:[e.jsxs("div",{className:"dialog-body",children:[e.jsxs("div",{className:"form-field",children:[e.jsx("label",{htmlFor:"project-name",children:"Название проекта *"}),e.jsx("input",{id:"project-name",type:"text",value:s,onChange:v=>r(v.target.value),placeholder:"Мой проект",maxLength:100,autoFocus:!0})]}),e.jsxs("div",{className:"form-field",children:[e.jsx("label",{htmlFor:"project-description",children:"Описание (необязательно)"}),e.jsx("textarea",{id:"project-description",value:h,onChange:v=>a(v.target.value),placeholder:"Краткое описание проекта...",maxLength:500,rows:3})]}),e.jsxs("div",{className:"form-section",children:[e.jsx("h3",{children:"Размер холста"}),e.jsx("div",{className:"presets-grid",children:b.map((v,f)=>e.jsxs("button",{type:"button",className:`preset-btn ${n===v.width&&i===v.height?"active":""}`,onClick:()=>{c(v.width),l(v.height)},children:[e.jsx("span",{className:"preset-name",children:v.name}),e.jsxs("span",{className:"preset-size",children:[v.width,"×",v.height]})]},f))}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-field",children:[e.jsx("label",{htmlFor:"canvas-width",children:"Ширина (px)"}),e.jsx("input",{id:"canvas-width",type:"number",value:n,onChange:v=>c(parseInt(v.target.value)||1920),min:320,max:7680})]}),e.jsxs("div",{className:"form-field",children:[e.jsx("label",{htmlFor:"canvas-height",children:"Высота (px)"}),e.jsx("input",{id:"canvas-height",type:"number",value:i,onChange:v=>l(parseInt(v.target.value)||1080),min:240,max:4320})]})]})]})]}),e.jsxs("div",{className:"dialog-footer",children:[e.jsx("button",{type:"button",className:"btn-secondary",onClick:t,children:"Отмена"}),e.jsx("button",{type:"submit",className:"btn-primary",disabled:p,children:p?"Создание...":"Создать проект"})]})]})]})})},Yt=({onClose:t,onProjectLoaded:o})=>{const[s,r]=k.useState([]),[h,a]=k.useState(!0),[n,c]=k.useState(""),[i,l]=k.useState(!1),{loadProject:p,projectId:x}=U();k.useEffect(()=>{m()},[]);const m=async()=>{try{a(!0);const u=await H.getProjects();console.log("[ProjectsDialog] Projects loaded:",u.projects.length),r(u.projects)}catch(u){console.error("[ProjectsDialog] Failed to load projects:",u),alert("Не удалось загрузить список проектов")}finally{a(!1)}},g=async u=>{try{console.log("[ProjectsDialog] Opening project:",u),await p(u),o?.(),t()}catch(N){console.error("[ProjectsDialog] Failed to open project:",N),alert("Не удалось открыть проект")}},b=async(u,N)=>{if(confirm(`Вы уверены что хотите удалить проект "${N}"?`))try{console.log("[ProjectsDialog] Deleting project:",u),await H.deleteProject(u),r(s.filter(S=>S.id!==u)),alert("Проект удалён")}catch(S){console.error("[ProjectsDialog] Failed to delete project:",S),alert("Не удалось удалить проект")}},v=()=>{l(!1),m()},f=s.filter(u=>u.name.toLowerCase().includes(n.toLowerCase())||u.description?.toLowerCase().includes(n.toLowerCase()));return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"dialog-overlay",onClick:t,children:e.jsxs("div",{className:"dialog-content projects-dialog",onClick:u=>u.stopPropagation(),children:[e.jsxs("div",{className:"dialog-header",children:[e.jsx("h2",{children:"Мои проекты"}),e.jsx("button",{className:"btn-icon",onClick:t,title:"Закрыть",children:e.jsx(Fe,{size:24})})]}),e.jsxs("div",{className:"projects-toolbar",children:[e.jsxs("div",{className:"search-box",children:[e.jsx(vt,{size:18}),e.jsx("input",{type:"text",placeholder:"Поиск проектов...",value:n,onChange:u=>c(u.target.value)})]}),e.jsxs("button",{className:"btn-primary",onClick:()=>l(!0),children:[e.jsx(gt,{size:18}),e.jsx("span",{children:"Создать проект"})]})]}),e.jsx("div",{className:"projects-list",children:h?e.jsx("div",{className:"loading-state",children:e.jsx("p",{children:"Загрузка проектов..."})}):f.length===0?e.jsxs("div",{className:"empty-state",children:[e.jsx(le,{size:48}),e.jsx("p",{children:n?"Проекты не найдены":"У вас пока нет проектов"}),e.jsx("button",{className:"btn-primary",onClick:()=>l(!0),children:"Создать первый проект"})]}):f.map(u=>e.jsxs("div",{className:`project-card ${u.id===x?"active":""}`,children:[e.jsx("div",{className:"project-thumbnail",children:u.thumbnail?e.jsx("img",{src:u.thumbnail,alt:u.name}):e.jsx("div",{className:"thumbnail-placeholder",children:e.jsx(le,{size:32})})}),e.jsxs("div",{className:"project-info",children:[e.jsx("h3",{children:u.name}),u.description&&e.jsx("p",{className:"project-description",children:u.description}),e.jsxs("div",{className:"project-meta",children:[e.jsxs("span",{children:[u.canvasWidth,"×",u.canvasHeight]}),e.jsx("span",{children:"•"}),e.jsx("span",{children:new Date(u.updatedAt).toLocaleDateString("ru-RU")})]}),u.tags&&u.tags.length>0&&e.jsx("div",{className:"project-tags",children:u.tags.map((N,S)=>e.jsx("span",{className:"tag",children:N},S))})]}),e.jsxs("div",{className:"project-actions",children:[e.jsxs("button",{className:"btn-primary",onClick:()=>g(u.id),title:"Открыть проект",children:[e.jsx(le,{size:18}),e.jsx("span",{children:"Открыть"})]}),e.jsx("button",{className:"btn-icon btn-danger",onClick:()=>b(u.id,u.name),title:"Удалить проект",children:e.jsx(De,{size:18})})]})]},u.id))}),e.jsx("div",{className:"dialog-footer",children:e.jsxs("p",{className:"projects-count",children:["Всего проектов: ",s.length]})})]})}),i&&e.jsx(Kt,{onClose:()=>l(!1),onSuccess:v})]})},Zt=()=>{const{project:t,history:o,zoom:s,gridEnabled:r,snapToGrid:h,undo:a,redo:n,setZoom:c,toggleGrid:i,toggleSnapToGrid:l,saveProject:p}=U(),{project:x,savePreviewSnapshot:m}=U(),[g,b]=V.useState(!1),[v,f]=k.useState(null),[u,N]=k.useState(null),[S,C]=k.useState(!1);k.useEffect(()=>{const M=H.getOrganizationData();f(M.name),N(M.plan)},[]);const I=()=>{c(Math.min(s+.1,3))},T=()=>{c(Math.max(s-.1,.1))},d=()=>{confirm("Вы уверены что хотите выйти?")&&(D.info("User initiated logout"),H.logout(),window.location.href="/login")},y=async()=>{if(!(x||t)){alert("Нет открытого проекта для предпросмотра");return}b(!0);try{console.log("[Toolbar] Starting preview...");const _=await m();window.open(`/preview?projectId=${_}`,"_blank"),console.log("[Toolbar] Preview opened")}catch(_){console.error("[Toolbar] Error:",_),alert(`Ошибка: ${_.message}`)}finally{b(!1)}},j=o.past.length>0,E=o.future.length>0;return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"toolbar",children:[e.jsxs("div",{className:"toolbar-section",children:[e.jsx("div",{className:"toolbar-logo",children:e.jsx("span",{className:"logo-text",children:"Kiosk Editor"})}),e.jsx("div",{className:"toolbar-divider"}),e.jsx("button",{className:"toolbar-btn",onClick:()=>p(),disabled:!t,title:"Сохранить (Ctrl+S)",children:e.jsx(jt,{size:18})}),e.jsx("button",{className:"toolbar-btn",onClick:()=>C(!0),disabled:!t,title:"Мои проекты",children:e.jsx(le,{size:18})}),e.jsx("div",{className:"toolbar-divider"}),e.jsx("button",{className:"toolbar-btn",onClick:a,disabled:!j,title:"Отменить (Ctrl+Z)",children:e.jsx(kt,{size:18})}),e.jsx("button",{className:"toolbar-btn",onClick:n,disabled:!E,title:"Вернуть (Ctrl+Shift+Z)",children:e.jsx(mt,{size:18})}),e.jsx("div",{className:"toolbar-divider"}),e.jsx("button",{className:"toolbar-btn",onClick:T,disabled:s<=.1,title:"Уменьшить (Ctrl+-)",children:e.jsx(Et,{size:18})}),e.jsxs("span",{className:"toolbar-zoom",children:[Math.round(s*100),"%"]}),e.jsx("button",{className:"toolbar-btn",onClick:I,disabled:s>=3,title:"Увеличить (Ctrl++)",children:e.jsx(wt,{size:18})}),e.jsx("div",{className:"toolbar-divider"}),e.jsx("button",{className:`toolbar-btn ${r?"active":""}`,onClick:i,title:"Показать сетку",children:e.jsx(lt,{size:18})}),e.jsx("button",{className:`toolbar-btn ${h?"active":""}`,onClick:l,title:"Привязка к сетке",children:e.jsx(pt,{size:18})})]}),e.jsxs("div",{className:"toolbar-section",children:[t&&e.jsx(Xt,{}),e.jsx("div",{className:"toolbar-divider"}),v&&e.jsxs("div",{className:"toolbar-user-info",children:[e.jsx(Ct,{size:16}),e.jsx("span",{className:"user-org",children:v}),u&&e.jsx("span",{className:"user-plan",children:u})]}),e.jsx("button",{className:"toolbar-btn logout-btn",onClick:d,title:"Выйти",children:e.jsx(ht,{size:18})}),e.jsx("div",{className:"toolbar-divider"}),e.jsxs("button",{className:"toolbar-btn preview-btn",disabled:!t||g,onClick:y,title:"Предпросмотр",children:[e.jsx(ft,{size:18}),e.jsx("span",{children:g?"Загрузка...":"Предпросмотр"})]})]})]}),S&&e.jsx(Yt,{onClose:()=>C(!1)})]})},Oe=({widget:t,image:o})=>{const s=k.useRef(null),{clipShape:r="rectangle",cornerRadius:h=0,opacity:a=1}=t.properties;return k.useEffect(()=>{if(!s.current||!o)return;const n=s.current,c=document.createElement("canvas"),i=c.getContext("2d");if(!i)return;c.width=t.width,c.height=t.height,i.clearRect(0,0,c.width,c.height),i.save();const l=t.width/2,p=t.height/2,x=Math.min(t.width,t.height)/2;switch(r){case"circle":i.beginPath(),i.arc(l,p,x,0,Math.PI*2),i.closePath();break;case"ellipse":i.beginPath(),i.ellipse(l,p,t.width/2,t.height/2,0,0,Math.PI*2),i.closePath();break;case"triangle":i.beginPath(),i.moveTo(l,p-x),i.lineTo(l+x*Math.cos(Math.PI/6),p+x*Math.sin(Math.PI/6)),i.lineTo(l-x*Math.cos(Math.PI/6),p+x*Math.sin(Math.PI/6)),i.closePath();break;case"diamond":i.beginPath(),i.moveTo(l,0),i.lineTo(t.width,p),i.lineTo(l,t.height),i.lineTo(0,p),i.closePath();break;case"pentagon":fe(i,l,p,x,5);break;case"hexagon":fe(i,l,p,x,6);break;case"octagon":fe(i,l,p,x,8);break;case"star":i.beginPath();for(let d=0;d<10;d++){const y=d*Math.PI/5-Math.PI/2,j=d%2===0?x:x*.5,E=l+j*Math.cos(y),M=p+j*Math.sin(y);d===0?i.moveTo(E,M):i.lineTo(E,M)}i.closePath();break;case"rounded-rectangle":Jt(i,0,0,t.width,t.height,h);break;default:i.rect(0,0,t.width,t.height);break}i.clip();const m=o.width/o.height,g=t.width/t.height;let b=0,v=0,f=o.width,u=o.height,N=0,S=0,C=t.width,I=t.height;m>g?(f=o.height*g,b=(o.width-f)/2):(u=o.width/g,v=(o.height-u)/2),i.drawImage(o,b,v,f,u,N,S,C,I),i.restore();const T=new window.Image;T.src=c.toDataURL(),T.onload=()=>{n&&(n.image(T),n.getLayer()?.batchDraw())}},[o,t.width,t.height,r,h]),o?e.jsx(se,{ref:s,image:void 0,width:t.width,height:t.height,opacity:a,listening:!1}):null};function fe(t,o,s,r,h){t.beginPath();for(let a=0;a<h;a++){const n=a*2*Math.PI/h-Math.PI/2,c=o+r*Math.cos(n),i=s+r*Math.sin(n);a===0?t.moveTo(c,i):t.lineTo(c,i)}t.closePath()}function Jt(t,o,s,r,h,a){t.beginPath(),t.moveTo(o+a,s),t.lineTo(o+r-a,s),t.quadraticCurveTo(o+r,s,o+r,s+a),t.lineTo(o+r,s+h-a),t.quadraticCurveTo(o+r,s+h,o+r-a,s+h),t.lineTo(o+a,s+h),t.quadraticCurveTo(o,s+h,o,s+h-a),t.lineTo(o,s+a),t.quadraticCurveTo(o,s,o+a,s),t.closePath()}const Qt=({widget:t,isSelected:o,onSelect:s,onDragEnd:r,onTransformEnd:h,dragBoundFunc:a})=>{const n=k.useRef(null),[c,i]=k.useState({}),[l,p]=k.useState(0),[x,m]=k.useState(!1),g=k.useRef(),{sources:b=[],autoSwitch:v=!1,switchInterval:f=3,transition:u="fade",clipShape:N="rectangle",loop:S=!0}=t.properties;k.useEffect(()=>{const d={};let y=0;return b.forEach(j=>{const E=new window.Image;E.crossOrigin="anonymous",E.onload=()=>{d[j.id]=E,y++,y===b.length&&i({...d})},E.onerror=()=>{console.error("Failed to load image:",j.value),y++,y===b.length&&i({...d})},E.src=j.value}),()=>{Object.values(d).forEach(j=>{j.onload=null,j.onerror=null})}},[b]),k.useEffect(()=>{if(!v||b.length<=1){g.current&&clearInterval(g.current);return}return g.current=setInterval(()=>{p(d=>{const y=d+1;return y>=b.length?S?0:d:y})},f*1e3),()=>{g.current&&clearInterval(g.current)}},[v,f,b.length,S]);const C=t.locked||!1,I=b[l],T=I?c[I.id]:null;return e.jsxs(K,{ref:n,id:t.id,x:t.x,y:t.y,width:t.width,height:t.height,rotation:t.rotation||0,draggable:!C,dragBoundFunc:a,opacity:C?.6:1,onClick:s,onTap:s,onDragEnd:r,onTransformEnd:h,children:[e.jsx(P,{width:t.width,height:t.height,fill:"transparent",listening:!0}),(!T||b.length===0)&&e.jsx(P,{width:t.width,height:t.height,fill:"#9b59b6",listening:!1}),T&&(N&&N!=="rectangle"?e.jsx(Oe,{widget:t,image:T}):e.jsx(se,{image:T,x:0,y:0,width:t.width,height:t.height,listening:!1})),o&&e.jsx(P,{width:t.width,height:t.height,stroke:"#007acc",strokeWidth:2,listening:!1}),b.length>1&&e.jsx(P,{x:t.width-40,y:t.height-20,width:35,height:15,fill:"rgba(0, 0, 0, 0.7)",cornerRadius:3,listening:!1}),b.length>1&&e.jsx(se,{x:t.width-35,y:t.height-18,width:10,height:10,image:(()=>{const d=document.createElement("canvas");d.width=10,d.height=10;const y=d.getContext("2d");y&&(y.fillStyle="#fff",y.font="10px Arial",y.fillText("📷",0,9));const j=new window.Image;return j.src=d.toDataURL(),j})(),listening:!1})]})},er=({widget:t,isSelected:o,onSelect:s,onDragEnd:r,onTransformEnd:h,dragBoundFunc:a})=>{if(t.properties.galleryMode)return e.jsx(Qt,{widget:t,isSelected:o,onSelect:s,onDragEnd:r,onTransformEnd:h,dragBoundFunc:a});const[n,c]=k.useState(null),i=k.useRef(null),{clipShape:l="rectangle"}=t.properties;k.useEffect(()=>{if(!t.properties.src){c(null);return}const S=new window.Image;return S.crossOrigin="anonymous",S.onload=()=>{c(S)},S.onerror=()=>{console.error("Failed to load image:",t.properties.src),c(null)},S.src=t.properties.src,()=>{S.onload=null,S.onerror=null}},[t.properties.src]),k.useEffect(()=>{if(!n||t.properties.objectFit!=="adaptive")return;const{updateWidget:S}=U.getState(),C=n.width/n.height,I=t.width/t.height;if(Math.abs(C-I)>.01){const T=t.width/C;S(t.id,{height:Math.round(T)})}},[n,t.properties.objectFit,t.width,t.height,t.id]);const x=(()=>{if(!n)return null;const{width:S,height:C}=t,{objectFit:I="contain"}=t.properties,T=n.width/n.height,d=S/C;let y=0,j=0,E=n.width,M=n.height;switch(I){case"cover":{T>d?(E=n.height*d,y=(n.width-E)/2):(M=n.width/d,j=(n.height-M)/2);break}case"contain":break;case"fill":break;case"scale-down":{n.width<=S&&n.height<=C&&(E=n.width,M=n.height);break}}return{cropX:y,cropY:j,cropWidth:E,cropHeight:M}})(),{borderEnabled:m,borderStyle:g,borderWidth:b=2,borderColor:v="#000000"}=t.properties,f=S=>{switch(S){case"dashed":return[10,5];case"dotted":return[2,2];case"double":return[];default:return[]}},u=S=>{i.current&&h(S)},N=t.locked||!1;return e.jsxs(K,{ref:i,id:t.id,x:t.x,y:t.y,width:t.width,height:t.height,rotation:t.rotation||0,draggable:!N,dragBoundFunc:a,opacity:N?.6:1,onClick:s,onTap:s,onDragEnd:r,onTransformEnd:u,children:[e.jsx(P,{width:t.width,height:t.height,fill:"transparent",listening:!0}),!n&&e.jsx(P,{width:t.width,height:t.height,fill:"#9b59b6",listening:!1}),n&&(l&&l!=="rectangle"?e.jsx(Oe,{widget:t,image:n}):x&&e.jsx(se,{image:n,x:0,y:0,width:t.width,height:t.height,crop:{x:x.cropX,y:x.cropY,width:x.cropWidth,height:x.cropHeight},listening:!1})),o&&e.jsx(P,{width:t.width,height:t.height,stroke:"#007acc",strokeWidth:2,listening:!1}),m&&e.jsx(P,{width:t.width,height:t.height,stroke:v,strokeWidth:b,dash:f(g),listening:!1})]})},tr=({widget:t,isSelected:o,onSelect:s,onDragEnd:r,onTransformEnd:h,dragBoundFunc:a})=>{const n=k.useRef(null),c=k.useRef(null),{text:i="Button",backgroundColor:l="#2ecc71",textColor:p="#ffffff",fontSize:x=16,fontFamily:m="Arial",fontWeight:g="normal",fontStyle:b="normal",textAlign:v="center",borderRadius:f=8,borderWidth:u=0,borderColor:N="#000000",borderStyle:S="solid",paddingX:C=16,paddingY:I=8,shadowEnabled:T=!1,shadowColor:d="#000000",shadowBlur:y=10,shadowOffsetX:j=0,shadowOffsetY:E=4,shadowOpacity:M=.3}=t.properties,_=t.locked||!1,A=()=>{switch(S){case"dashed":return[10,5];case"dotted":return[3,3];default:return[]}};return e.jsxs(K,{ref:n,id:t.id,x:t.x,y:t.y,width:t.width,height:t.height,rotation:t.rotation||0,draggable:!_,dragBoundFunc:a,opacity:_?.6:1,onClick:s,onTap:s,onDragEnd:r,onTransformEnd:h,children:[T&&e.jsx(P,{x:j,y:E,width:t.width,height:t.height,cornerRadius:f,fill:d,opacity:M,blur:y,listening:!1}),e.jsx(P,{width:t.width,height:t.height,fill:l,cornerRadius:f,stroke:u>0?N:void 0,strokeWidth:u,dash:A(),listening:!1}),e.jsx(F,{ref:c,text:i,x:C,y:0,width:t.width-C*2,height:t.height,fontSize:x,fontFamily:m,fontStyle:g==="bold"?"bold":b,fill:p,align:v,verticalAlign:"middle",listening:!1}),e.jsx(P,{width:t.width,height:t.height,fill:"transparent",listening:!0}),o&&e.jsx(P,{width:t.width,height:t.height,stroke:"#007acc",strokeWidth:2,cornerRadius:f,listening:!1})]})},rr=({widget:t,isSelected:o,onSelect:s,onDragEnd:r,onTransformEnd:h,dragBoundFunc:a})=>{const n=k.useRef(null),{text:c="Text",fontSize:i=16,fontFamily:l="Arial",fontWeight:p="normal",fontStyle:x="normal",textAlign:m="left",verticalAlign:g="top",textColor:b="#000000",backgroundColor:v="#ffffff",lineHeight:f=1.2,padding:u=8,textDecoration:N="none"}=t.properties,S=t.locked||!1,C=()=>N==="underline"?"underline":N==="line-through"?"line-through":"";return e.jsxs(K,{ref:n,id:t.id,x:t.x,y:t.y,width:t.width,height:t.height,rotation:t.rotation||0,draggable:!S,dragBoundFunc:a,opacity:S?.6:1,onClick:s,onTap:s,onDragEnd:r,onTransformEnd:h,children:[v!=="transparent"&&e.jsx(P,{width:t.width,height:t.height,fill:v,listening:!1}),e.jsx(F,{text:c,x:u,y:u,width:t.width-u*2,height:t.height-u*2,fontSize:i,fontFamily:l,fontStyle:p==="bold"?"bold":x,fill:b,align:m,verticalAlign:g,lineHeight:f,textDecoration:C(),listening:!1}),e.jsx(P,{width:t.width,height:t.height,fill:"transparent",listening:!0}),o&&e.jsx(P,{width:t.width,height:t.height,stroke:"#007acc",strokeWidth:2,listening:!1})]})},nr=({widget:t,isSelected:o,onSelect:s,onDragEnd:r,onTransformEnd:h,dragBoundFunc:a})=>{const n=k.useRef(null),[c,i]=k.useState(0),{sources:l=[],autoNext:p=!0,loop:x=!0}=t.properties,m=t.locked||!1;return l[c],e.jsxs(K,{ref:n,id:t.id,x:t.x,y:t.y,width:t.width,height:t.height,rotation:t.rotation||0,draggable:!m,dragBoundFunc:a,opacity:m?.6:1,onClick:s,onTap:s,onDragEnd:r,onTransformEnd:h,children:[e.jsx(P,{width:t.width,height:t.height,fill:"transparent",listening:!0}),e.jsx(P,{width:t.width,height:t.height,fill:"#000000",listening:!1}),e.jsx(F,{x:t.width/2,y:t.height/2-30,text:"▶",fontSize:60,fill:"#ffffff",align:"center",width:t.width,offsetX:t.width/2,listening:!1}),e.jsx(F,{x:0,y:t.height/2+40,text:"PLAYLIST",fontSize:16,fill:"#ffffff",align:"center",width:t.width,listening:!1}),o&&e.jsx(P,{width:t.width,height:t.height,stroke:"#007acc",strokeWidth:2,listening:!1}),l.length>1&&e.jsxs(e.Fragment,{children:[e.jsx(P,{x:t.width-50,y:t.height-25,width:45,height:20,fill:"rgba(0, 0, 0, 0.8)",cornerRadius:4,listening:!1}),e.jsx(F,{x:t.width-48,y:t.height-21,text:`🎬 ${l.length}`,fontSize:12,fill:"#ffffff",listening:!1})]})]})},sr=({widget:t,isSelected:o,onSelect:s,onDragEnd:r,onTransformEnd:h,dragBoundFunc:a})=>{if(t.properties.playlistMode)return e.jsx(nr,{widget:t,isSelected:o,onSelect:s,onDragEnd:r,onTransformEnd:h,dragBoundFunc:a});const n=k.useRef(null),c=k.useRef(null),[i,l]=k.useState(null),p=k.useRef(),{sourceType:x="url",src:m="",rtspUrl:g="",isLocalFile:b=!1,fileName:v="",objectFit:f="contain",borderEnabled:u=!1,borderStyle:N="solid",borderWidth:S=2,borderColor:C="#000000",autoplay:I=!1,loop:T=!1,muted:d=!0,controls:y=!1}=t.properties;k.useEffect(()=>{const w=document.createElement("video");return w.crossOrigin="anonymous",w.loop=T,w.muted=d,w.playsInline=!0,x==="url"&&m?(w.src=m,w.onloadedmetadata=()=>{l(w),I&&w.play().catch(z=>{console.log("Autoplay prevented:",z)})},w.onerror=()=>{console.error("Failed to load video:",m),l(null)}):l(null),c.current=w,()=>{p.current&&cancelAnimationFrame(p.current),w.pause(),w.src="",w.load()}},[m,x,I,T,d]),k.useEffect(()=>{if(!i)return;const w=()=>{const z=n.current?.getLayer();z&&z.batchDraw(),p.current=requestAnimationFrame(w)};return p.current=requestAnimationFrame(w),()=>{p.current&&cancelAnimationFrame(p.current)}},[i]),k.useEffect(()=>{if(f!=="adaptive"||!i)return;const{updateWidget:w}=U.getState(),z=i.videoWidth/i.videoHeight||16/9,O=t.width/t.height;if(Math.abs(z-O)>.01){const B=t.width/z;w(t.id,{height:Math.round(B)})}},[f,i,t.width,t.height,t.id]);const E=(()=>{if(!i||i.videoWidth===0)return null;const{width:w,height:z}=t,O=i.videoWidth/i.videoHeight,B=w/z;let q=0,$=0,Q=i.videoWidth,X=i.videoHeight,Y=0,ie=0,Z=w,J=z;switch(f){case"cover":{O>B?(Q=i.videoHeight*B,q=(i.videoWidth-Q)/2):(X=i.videoWidth/B,$=(i.videoHeight-X)/2);break}case"contain":{O>B?(J=w/O,ie=(z-J)/2):(Z=z*O,Y=(w-Z)/2);break}case"scale-down":{i.videoWidth<=w&&i.videoHeight<=z?(Z=i.videoWidth,J=i.videoHeight,Y=(w-Z)/2,ie=(z-J)/2):O>B?(J=w/O,ie=(z-J)/2):(Z=z*O,Y=(w-Z)/2);break}}return{crop:{x:q,y:$,width:Q,height:X},position:{x:Y,y:ie,width:Z,height:J}}})(),M=w=>{switch(w){case"dashed":return[10,5];case"dotted":return[2,2];case"double":return[];default:return[]}},_=w=>{n.current&&h(w)},A=w=>{s(w),y&&i&&(i.paused?i.play():i.pause())},R=t.locked||!1,W=()=>x==="rtsp"&&g?`📹 RTSP
${g.substring(0,30)}...`:x==="url"&&m?b&&v?`📁 ${v}`:`🎥 Видео
${m.substring(0,30)}...`:`🎥 Видео
Нажмите для настройки`;return e.jsxs(K,{ref:n,id:t.id,x:t.x,y:t.y,width:t.width,height:t.height,rotation:t.rotation||0,draggable:!R,dragBoundFunc:a,opacity:R?.6:1,onClick:A,onTap:A,onDragEnd:r,onTransformEnd:_,children:[e.jsx(P,{width:t.width,height:t.height,fill:"transparent",listening:!0}),e.jsx(P,{width:t.width,height:t.height,fill:x==="rtsp"?"#2c3e50":"#f39c12",listening:!1}),i&&E?e.jsx(se,{image:i,x:E.position.x,y:E.position.y,width:E.position.width,height:E.position.height,crop:E.crop,listening:!1}):e.jsx(F,{text:W(),x:0,y:0,width:t.width,height:t.height,fontSize:14,fontFamily:"Arial",fill:"#ffffff",align:"center",verticalAlign:"middle",listening:!1}),x==="rtsp"&&e.jsx(P,{x:10,y:10,width:45,height:20,fill:"#ff0000",cornerRadius:4,listening:!1}),x==="rtsp"&&e.jsx(F,{text:"LIVE",x:10,y:13,width:45,fontSize:12,fontFamily:"Arial",fontWeight:"bold",fill:"#ffffff",align:"center",listening:!1}),i&&!i.paused&&e.jsx(F,{text:"▶",x:t.width-30,y:10,fontSize:16,fontFamily:"Arial",fill:"#00ff00",listening:!1}),y&&i&&e.jsx(F,{text:i.paused?"⏸ Пауза":"▶ Играет",x:10,y:t.height-30,fontSize:12,fontFamily:"Arial",fill:"#ffffff",listening:!1}),o&&e.jsx(P,{width:t.width,height:t.height,stroke:"#007acc",strokeWidth:2,listening:!1}),u&&e.jsx(P,{width:t.width,height:t.height,stroke:C,strokeWidth:S,dash:M(N),listening:!1})]})},ir=({widget:t,isSelected:o,onSelect:s,onDragEnd:r,onTransformEnd:h,dragBoundFunc:a})=>{const n=k.useRef(null),{shapeType:c="rectangle",fillColor:i="#4a90e2",strokeColor:l="#2c3e50",strokeWidth:p=0,cornerRadius:x=0,opacity:m=1}=t.properties,g=t.locked||!1,b=()=>{const v={fill:i,stroke:p>0?l:void 0,strokeWidth:p,opacity:m,listening:!1};switch(c){case"rectangle":return e.jsx(P,{x:0,y:0,width:t.width,height:t.height,cornerRadius:x,...v});case"circle":const f=Math.min(t.width,t.height)/2;return e.jsx(Xe,{x:t.width/2,y:t.height/2,radius:f,...v});case"ellipse":return e.jsx(Ge,{x:t.width/2,y:t.height/2,radiusX:t.width/2,radiusY:t.height/2,...v});case"triangle":return e.jsx(oe,{x:t.width/2,y:t.height/2,sides:3,radius:Math.min(t.width,t.height)/2,...v});case"pentagon":return e.jsx(oe,{x:t.width/2,y:t.height/2,sides:5,radius:Math.min(t.width,t.height)/2,...v});case"hexagon":return e.jsx(oe,{x:t.width/2,y:t.height/2,sides:6,radius:Math.min(t.width,t.height)/2,...v});case"star":return e.jsx(Ve,{x:t.width/2,y:t.height/2,numPoints:5,innerRadius:Math.min(t.width,t.height)/4,outerRadius:Math.min(t.width,t.height)/2,...v});case"diamond":return e.jsx(oe,{x:t.width/2,y:t.height/2,sides:4,radius:Math.min(t.width,t.height)/2,rotation:45,...v});case"line":return e.jsx(ne,{points:[0,t.height/2,t.width,t.height/2],stroke:l,strokeWidth:Math.max(p,2),opacity:m,listening:!1});case"arrow":const u=t.width,N=t.height,S=N*.6,C=N*.4;return e.jsx(ne,{points:[0,N/2-C/2,u-S,N/2-C/2,u-S,0,u,N/2,u-S,N,u-S,N/2+C/2,0,N/2+C/2],closed:!0,fill:i,stroke:p>0?l:void 0,strokeWidth:p,opacity:m,listening:!1});default:return e.jsx(P,{x:0,y:0,width:t.width,height:t.height,...v})}};return e.jsxs(K,{ref:n,id:t.id,x:t.x,y:t.y,width:t.width,height:t.height,rotation:t.rotation||0,draggable:!g,dragBoundFunc:a,opacity:g?.6:1,onClick:s,onTap:s,onDragEnd:r,onTransformEnd:h,children:[e.jsx(P,{width:t.width,height:t.height,fill:"transparent",listening:!0}),b(),o&&e.jsx(P,{width:t.width,height:t.height,stroke:"#007acc",strokeWidth:2,listening:!1})]})},or=({widget:t,isSelected:o,onSelect:s,onDragEnd:r,onTransformEnd:h,dragBoundFunc:a})=>{const n=k.useRef(null),[c,i]=k.useState(null),[l,p]=k.useState(null),{orientation:x="horizontal",items:m=[{id:"1",label:"Главная"},{id:"2",label:"О нас"},{id:"3",label:"Услуги",children:[{id:"3-1",label:"Услуга 1"},{id:"3-2",label:"Услуга 2"}]},{id:"4",label:"Контакты"}],backgroundColor:g="#2c3e50",textColor:b="#ffffff",hoverColor:v="#34495e",fontSize:f=16,fontFamily:u="Arial",itemPadding:N=16,submenuBackgroundColor:S="#34495e",submenuTextColor:C="#ffffff",borderWidth:I=0,borderColor:T="#000000",itemHeight:d=40}=t.properties,y=t.locked||!1,j=x==="horizontal",E=A=>A.length*(f*.6)+N*2,M=()=>{const A=[];let R=0;return m.forEach((W,w)=>{const z=E(W.label),O=c===W.id,B=l===W.id,q=W.children&&W.children.length>0;A.push(e.jsx(P,{x:R,y:0,width:z,height:d,fill:O?v:g,listening:!0,onMouseEnter:()=>i(W.id),onMouseLeave:()=>i(null),onClick:()=>{q&&p(l===W.id?null:W.id)}},`bg-${W.id}`)),A.push(e.jsx(F,{x:R,y:0,width:z,height:d,text:W.label,fontSize:f,fontFamily:u,fill:b,align:"center",verticalAlign:"middle",listening:!1},`text-${W.id}`)),q&&A.push(e.jsx(F,{x:R+z-20,y:0,width:20,height:d,text:"▼",fontSize:10,fill:b,align:"center",verticalAlign:"middle",listening:!1},`arrow-${W.id}`)),w<m.length-1&&A.push(e.jsx(ne,{points:[R+z,5,R+z,d-5],stroke:T,strokeWidth:1,opacity:.3,listening:!1},`divider-${W.id}`)),B&&q&&W.children.forEach(($,Q)=>{const X=d+Q*d,Y=Math.max(z,E($.label));A.push(e.jsx(P,{x:R,y:X,width:Y,height:d,fill:S,listening:!0,onMouseEnter:()=>i($.id),onMouseLeave:()=>i(null)},`submenu-bg-${$.id}`)),A.push(e.jsx(F,{x:R+N/2,y:X,width:Y-N/2,height:d,text:$.label,fontSize:f-2,fontFamily:u,fill:C,align:"left",verticalAlign:"middle",listening:!1},`submenu-text-${$.id}`))}),R+=z}),A},_=()=>{const A=[];let R=0;const W=t.width;return m.forEach((w,z)=>{const O=c===w.id,B=l===w.id,q=w.children&&w.children.length>0;A.push(e.jsx(P,{x:0,y:R,width:W,height:d,fill:O?v:g,listening:!0,onMouseEnter:()=>i(w.id),onMouseLeave:()=>i(null),onClick:()=>{q&&p(l===w.id?null:w.id)}},`bg-${w.id}`)),A.push(e.jsx(F,{x:N,y:R,width:W-N*2-(q?20:0),height:d,text:w.label,fontSize:f,fontFamily:u,fill:b,align:"left",verticalAlign:"middle",listening:!1},`text-${w.id}`)),q&&A.push(e.jsx(F,{x:W-20,y:R,width:20,height:d,text:B?"▼":"▶",fontSize:10,fill:b,align:"center",verticalAlign:"middle",listening:!1},`arrow-${w.id}`)),R+=d,z<m.length-1&&!B&&A.push(e.jsx(ne,{points:[10,R,W-10,R],stroke:T,strokeWidth:1,opacity:.3,listening:!1},`divider-${w.id}`)),B&&q&&(w.children.forEach(($,Q)=>{const X=c===$.id;A.push(e.jsx(P,{x:0,y:R,width:W,height:d,fill:X?v:S,listening:!0,onMouseEnter:()=>i($.id),onMouseLeave:()=>i(null)},`submenu-bg-${$.id}`)),A.push(e.jsx(F,{x:N*2,y:R,width:W-N*3,height:d,text:$.label,fontSize:f-2,fontFamily:u,fill:C,align:"left",verticalAlign:"middle",listening:!1},`submenu-text-${$.id}`)),R+=d}),z<m.length-1&&A.push(e.jsx(ne,{points:[10,R,W-10,R],stroke:T,strokeWidth:1,opacity:.3,listening:!1},`divider-after-${w.id}`)))}),A};return e.jsxs(K,{ref:n,id:t.id,x:t.x,y:t.y,width:t.width,height:t.height,rotation:t.rotation||0,draggable:!y,dragBoundFunc:a,opacity:y?.6:1,onClick:s,onTap:s,onDragEnd:r,onTransformEnd:h,children:[e.jsx(P,{width:t.width,height:t.height,fill:"transparent",listening:!0}),e.jsx(P,{width:t.width,height:t.height,fill:g,listening:!1}),I>0&&e.jsx(P,{width:t.width,height:t.height,stroke:T,strokeWidth:I,listening:!1}),j?M():_(),o&&e.jsx(P,{width:t.width,height:t.height,stroke:"#007acc",strokeWidth:2,listening:!1})]})},ar={shape:"#4a90e2",rectangle:"#4a90e2",button:"#2ecc71",text:"#e74c3c",image:"#9b59b6",video:"#f39c12"},lr=()=>{const{project:t,selectedWidgetIds:o,selectWidget:s,clearSelection:r,updateWidget:h,zoom:a,gridEnabled:n,snapToGrid:c,gridSize:i,gridLineWidth:l,gridColor:p,pendingWidget:x,addWidgetAtPosition:m,clearPendingWidget:g}=U(),b=k.useRef(null),v=k.useRef(null),f=d=>c?Math.round(d/i)*i:d,u=d=>({x:f(d.x),y:f(d.y)});if(k.useEffect(()=>{if(!v.current||!t)return;const d=b.current,y=o.map(j=>t.widgets.find(M=>M.id===j)?.locked?null:d.findOne(`#${j}`)).filter(Boolean);v.current.nodes(y),v.current.getLayer().batchDraw()},[o,t]),!t)return null;const N=d=>{if(x){const E=d.target.getStage().getPointerPosition();E&&m(E.x,E.y);return}(d.target===d.target.getStage()||d.target.attrs.id==="canvas-background")&&r()},S=(d,y)=>{y.cancelBubble=!0;const j=y.evt.ctrlKey||y.evt.metaKey;s(d,j)},C=(d,y)=>{const j=f(y.target.x()),E=f(y.target.y());h(d,{x:j,y:E})},I=(d,y)=>{const j=y.target,E=j.scaleX(),M=j.scaleY();j.scaleX(1),j.scaleY(1);const _=j.width?j.width():j.attrs.width||100,A=j.height?j.height():j.attrs.height||100;let R=Math.max(10,_*E),W=Math.max(10,A*M),w=j.x(),z=j.y();c&&(R=f(R),W=f(W),w=f(w),z=f(z)),h(d,{x:w,y:z,width:R,height:W,rotation:j.rotation()})},T=()=>{if(!n)return null;const d=[],{width:y,height:j}=t.canvas;for(let E=0;E<=y/i;E++)d.push(e.jsx(P,{x:E*i,y:0,width:l,height:j,fill:p},`v-${E}`));for(let E=0;E<=j/i;E++)d.push(e.jsx(P,{x:0,y:E*i,width:y,height:l,fill:p},`h-${E}`));return d};return e.jsxs("div",{className:"canvas-container",children:[e.jsx("div",{className:"canvas-scroll",children:e.jsx("div",{className:"canvas-wrapper",style:{transform:`scale(${a})`,transformOrigin:"top left",cursor:x?"crosshair":"default"},children:e.jsx(Ke,{ref:b,width:t.canvas.width,height:t.canvas.height,onClick:N,onTap:N,children:e.jsxs(Ye,{children:[e.jsx(P,{id:"canvas-background",x:0,y:0,width:t.canvas.width,height:t.canvas.height,fill:t.canvas.backgroundColor||"#ffffff"}),T(),t.widgets.slice().sort((d,y)=>(d.zIndex||0)-(y.zIndex||0)).map(d=>{const y=d.locked||!1;return d.type==="image"?e.jsxs(V.Fragment,{children:[e.jsx(er,{widget:d,isSelected:o.includes(d.id),onSelect:j=>S(d.id,j),onDragEnd:j=>C(d.id,j),onTransformEnd:j=>I(d.id,j),dragBoundFunc:c?u:void 0}),y&&e.jsx(F,{x:d.x+5,y:d.y+5,text:"🔒",fontSize:16,listening:!1})]},d.id):d.type==="button"?e.jsxs(V.Fragment,{children:[e.jsx(tr,{widget:d,isSelected:o.includes(d.id),onSelect:j=>S(d.id,j),onDragEnd:j=>C(d.id,j),onTransformEnd:j=>I(d.id,j),dragBoundFunc:c?u:void 0}),y&&e.jsx(F,{x:d.x+5,y:d.y+5,text:"🔒",fontSize:16,listening:!1})]},d.id):d.type==="text"?e.jsxs(V.Fragment,{children:[e.jsx(rr,{widget:d,isSelected:o.includes(d.id),onSelect:j=>S(d.id,j),onDragEnd:j=>C(d.id,j),onTransformEnd:j=>I(d.id,j),dragBoundFunc:c?u:void 0}),y&&e.jsx(F,{x:d.x+5,y:d.y+5,text:"🔒",fontSize:16,listening:!1})]},d.id):d.type==="video"?e.jsxs(V.Fragment,{children:[e.jsx(sr,{widget:d,isSelected:o.includes(d.id),onSelect:j=>S(d.id,j),onDragEnd:j=>C(d.id,j),onTransformEnd:j=>I(d.id,j),dragBoundFunc:c?u:void 0}),y&&e.jsx(F,{x:d.x+5,y:d.y+5,text:"🔒",fontSize:16,listening:!1})]},d.id):d.type==="shape"||d.type==="rectangle"?e.jsxs(V.Fragment,{children:[e.jsx(ir,{widget:d,isSelected:o.includes(d.id),onSelect:j=>S(d.id,j),onDragEnd:j=>C(d.id,j),onTransformEnd:j=>I(d.id,j),dragBoundFunc:c?u:void 0}),y&&e.jsx(F,{x:d.x+5,y:d.y+5,text:"🔒",fontSize:16,listening:!1})]},d.id):d.type==="menu"?e.jsxs(V.Fragment,{children:[e.jsx(or,{widget:d,isSelected:o.includes(d.id),onSelect:j=>S(d.id,j),onDragEnd:j=>C(d.id,j),onTransformEnd:j=>I(d.id,j),dragBoundFunc:c?u:void 0}),y&&e.jsx(F,{x:d.x+5,y:d.y+5,text:"🔒",fontSize:16,listening:!1})]},d.id):e.jsxs(V.Fragment,{children:[e.jsx(P,{id:d.id,x:d.x,y:d.y,width:d.width,height:d.height,rotation:d.rotation||0,fill:ar[d.type]||"#4a90e2",stroke:o.includes(d.id)?"#007acc":void 0,strokeWidth:o.includes(d.id)?2:0,opacity:y?.6:1,draggable:!y,onClick:j=>S(d.id,j),onTap:j=>S(d.id,j),onDragEnd:j=>C(d.id,j),onTransformEnd:j=>I(d.id,j)}),y&&e.jsx(F,{x:d.x+5,y:d.y+5,text:"🔒",fontSize:16,listening:!1})]},d.id)}),e.jsx(Ze,{ref:v,boundBoxFunc:(d,y)=>y.width<10||y.height<10?d:y})]})})})}),e.jsxs("div",{className:"canvas-info",children:[e.jsxs("span",{children:[t.canvas.width," × ",t.canvas.height," px"]}),o.length>0&&e.jsxs("span",{children:["Выбрано: ",o.length]})]})]})},cr=()=>{const{project:t,selectedWidgetIds:o,selectWidget:s,updateWidget:r,deleteWidget:h}=U();if(!t)return null;const a=i=>({shape:"🔷",rectangle:"🔷",text:"📝",button:"🔘",image:"🖼️",video:"🎬",menu:"🍔"})[i]||"⬜",n=i=>{if(i.properties.text){const l=i.properties.text.substring(0,20);return l.length<i.properties.text.length?`${l}...`:l}return i.properties.items?`Меню (${i.properties.items.length} пунктов)`:i.type.charAt(0).toUpperCase()+i.type.slice(1)},c=[...t.widgets].sort((i,l)=>(l.zIndex||0)-(i.zIndex||0));return e.jsxs("div",{className:"outline-panel",children:[e.jsxs("div",{className:"outline-header",children:[e.jsx("h3",{children:"Структура"}),e.jsxs("span",{className:"outline-count",children:[t.widgets.length," виджетов"]})]}),e.jsx("div",{className:"outline-list",children:c.length===0?e.jsxs("div",{className:"outline-empty",children:[e.jsx("p",{children:"Нет виджетов"}),e.jsx("span",{children:"Добавьте виджеты из библиотеки"})]}):c.map(i=>{const l=o.includes(i.id),p=i.locked||!1;return e.jsxs("div",{className:`outline-item ${l?"selected":""} ${p?"locked":""}`,onClick:()=>s(i.id,!1),children:[e.jsxs("div",{className:"outline-item-main",children:[e.jsx("span",{className:"outline-icon",children:a(i.type)}),e.jsxs("div",{className:"outline-info",children:[e.jsx("span",{className:"outline-label",children:n(i)}),e.jsxs("span",{className:"outline-meta",children:[i.width,"×",i.height," • z:",i.zIndex||0]})]})]}),e.jsxs("div",{className:"outline-actions",onClick:x=>x.stopPropagation(),children:[e.jsx("button",{className:"outline-action-btn",onClick:()=>{r(i.id,{locked:!p})},title:p?"Разблокировать":"Заблокировать",children:p?e.jsx(dt,{size:14}):e.jsx(St,{size:14})}),e.jsx("button",{className:"outline-action-btn delete",onClick:()=>{window.confirm(`Удалить виджет "${n(i)}"?`)&&h(i.id)},title:"Удалить",children:e.jsx(De,{size:14})})]})]},i.id)})})]})},dr=()=>{const{addWidget:t,project:o}=U(),s=[{type:"shape",name:"Фигура",icon:yt,defaultProps:{shapeType:"rectangle",fillColor:"#4a90e2",strokeColor:"#2c3e50",strokeWidth:0,cornerRadius:0,opacity:1}},{type:"button",name:"Кнопка",icon:xt,defaultProps:{text:"Нажми меня",backgroundColor:"#4a90e2",textColor:"#ffffff"}},{type:"text",name:"Текст",icon:bt,defaultProps:{text:"Введите текст",fontSize:24,color:"#000000"}},{type:"image",name:"Изображение",icon:ct,defaultProps:{src:""}},{type:"video",name:"Видео",icon:Nt,defaultProps:{src:"",autoplay:!1,loop:!1}},{type:"menu",name:"Меню",icon:ut,defaultProps:{orientation:"horizontal",items:[{id:"1",label:"Главная"},{id:"2",label:"О нас"},{id:"3",label:"Услуги",children:[{id:"3-1",label:"Услуга 1"},{id:"3-2",label:"Услуга 2"}]},{id:"4",label:"Контакты"}],backgroundColor:"#2c3e50",textColor:"#ffffff",hoverColor:"#34495e",fontSize:16,fontFamily:"Arial",itemPadding:16,submenuBackgroundColor:"#34495e",submenuTextColor:"#ffffff",borderWidth:0,borderColor:"#000000",itemHeight:40}}],r=(h,a)=>{if(!o)return;const{setPendingWidget:n}=U.getState();n(h,a)};return e.jsxs("div",{className:"widget-library panel",children:[e.jsx("div",{className:"widget-library-header",children:e.jsx("h3",{children:"Виджеты"})}),e.jsx("div",{className:"widget-library-content",children:s.map(h=>{const a=h.icon;return e.jsxs("button",{className:"widget-item",onClick:()=>r(h.type,h.defaultProps),title:`Добавить ${h.name}`,children:[e.jsx(a,{size:24}),e.jsx("span",{children:h.name})]},h.type)})}),e.jsx("div",{className:"widget-library-footer",children:e.jsx("button",{className:"btn-secondary",style:{width:"100%",fontSize:"12px"},children:"+ Импорт виджета"})}),e.jsx(cr,{})]})},hr="modulepreload",pr=function(t){return"/"+t},Pe={},ze=function(o,s,r){let h=Promise.resolve();if(s&&s.length>0){let i=function(l){return Promise.all(l.map(p=>Promise.resolve(p).then(x=>({status:"fulfilled",value:x}),x=>({status:"rejected",reason:x}))))};document.getElementsByTagName("link");const n=document.querySelector("meta[property=csp-nonce]"),c=n?.nonce||n?.getAttribute("nonce");h=i(s.map(l=>{if(l=pr(l),l in Pe)return;Pe[l]=!0;const p=l.endsWith(".css"),x=p?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${x}`))return;const m=document.createElement("link");if(m.rel=p?"stylesheet":hr,p||(m.as="script"),m.crossOrigin="",m.href=l,c&&m.setAttribute("nonce",c),document.head.appendChild(m),p)return new Promise((g,b)=>{m.addEventListener("load",g),m.addEventListener("error",()=>b(new Error(`Unable to preload CSS for ${l}`)))})}))}function a(n){const c=new Event("vite:preloadError",{cancelable:!0});if(c.payload=n,window.dispatchEvent(c),!c.defaultPrevented)throw n}return h.then(n=>{for(const c of n||[])c.status==="rejected"&&a(c.reason);return o().catch(a)})},We=({widget:t,onUpdate:o,allWidgets:s})=>{const r=t.properties.actions||[],h=()=>{const c={type:"url",url:""};o([...r,c])},a=(c,i)=>{const l=[...r];l[c]={...l[c],...i},o(l)},n=c=>{const i=r.filter((l,p)=>p!==c);o(i)};return e.jsxs("div",{className:"action-editor",children:[e.jsx("h4",{style:{marginBottom:"12px",fontSize:"12px",color:"#aaa"},children:"Действия при клике"}),r.length===0&&e.jsx("div",{style:{padding:"16px",background:"#252525",borderRadius:"6px",textAlign:"center",color:"#888",fontSize:"13px",marginBottom:"12px"},children:"Нет действий. Добавьте действие ниже."}),r.map((c,i)=>e.jsxs("div",{className:"action-item",children:[e.jsxs("div",{className:"action-header",children:[e.jsxs("span",{className:"action-number",children:["#",i+1]}),e.jsx("button",{className:"btn-danger-small",onClick:()=>n(i),title:"Удалить действие",children:"🗑️"})]}),e.jsxs("div",{className:"action-body",children:[e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"Тип действия"}),e.jsxs("select",{value:c.type,onChange:l=>a(i,{type:l.target.value}),children:[e.jsx("option",{value:"url",children:"🔗 Открыть URL"}),e.jsx("option",{value:"page",children:"📄 Перейти на страницу"}),e.jsx("option",{value:"popup",children:"💬 Показать popup"}),e.jsx("option",{value:"widget_show",children:"👁️ Показать виджет"}),e.jsx("option",{value:"widget_hide",children:"🙈 Скрыть виджет"}),e.jsx("option",{value:"video_play",children:"▶️ Воспроизвести видео"}),e.jsx("option",{value:"video_stop",children:"⏸️ Остановить видео"})]})]}),c.type==="url"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"URL адрес"}),e.jsx("input",{type:"text",value:c.url||"",onChange:l=>a(i,{url:l.target.value}),placeholder:"https://example.com"})]}),e.jsx("div",{className:"property-field",children:e.jsxs("label",{children:[e.jsx("input",{type:"checkbox",checked:c.openInNewTab||!1,onChange:l=>a(i,{openInNewTab:l.target.checked})}),"Открыть в новой вкладке"]})})]}),c.type==="page"&&e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"ID страницы"}),e.jsx("input",{type:"text",value:c.pageId||"",onChange:l=>a(i,{pageId:l.target.value}),placeholder:"page-1"}),e.jsx("div",{style:{fontSize:"11px",color:"#888",marginTop:"4px"},children:"Укажите ID страницы для перехода"})]}),c.type==="popup"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"Заголовок popup"}),e.jsx("input",{type:"text",value:c.popupTitle||"",onChange:l=>a(i,{popupTitle:l.target.value}),placeholder:"Заголовок"})]}),e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"Содержимое popup"}),e.jsx("textarea",{value:c.popupContent||"",onChange:l=>a(i,{popupContent:l.target.value}),rows:4,placeholder:"Текст сообщения..."})]}),e.jsxs("div",{style:{display:"flex",gap:"12px"},children:[e.jsxs("div",{className:"property-field",style:{flex:1},children:[e.jsx("label",{children:"Ширина (px)"}),e.jsx("input",{type:"number",value:c.popupWidth||400,onChange:l=>a(i,{popupWidth:parseInt(l.target.value)}),min:200,max:1e3})]}),e.jsxs("div",{className:"property-field",style:{flex:1},children:[e.jsx("label",{children:"Высота (px)"}),e.jsx("input",{type:"number",value:c.popupHeight||300,onChange:l=>a(i,{popupHeight:parseInt(l.target.value)}),min:150,max:800})]})]})]}),(c.type==="widget_show"||c.type==="widget_hide")&&e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"Целевой виджет"}),e.jsxs("select",{value:c.targetWidgetId||"",onChange:l=>a(i,{targetWidgetId:l.target.value}),children:[e.jsx("option",{value:"",children:"Выберите виджет..."}),s.filter(l=>l.id!==t.id).map(l=>e.jsxs("option",{value:l.id,children:[l.type," - ",l.id]},l.id))]})]}),(c.type==="video_play"||c.type==="video_stop")&&e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"Видео виджет"}),e.jsxs("select",{value:c.targetWidgetId||"",onChange:l=>a(i,{targetWidgetId:l.target.value}),children:[e.jsx("option",{value:"",children:"Выберите видео..."}),s.filter(l=>l.type==="video").map(l=>e.jsxs("option",{value:l.id,children:["Video - ",l.id]},l.id))]})]})]})]},i)),e.jsx("button",{className:"btn-secondary",onClick:h,style:{width:"100%",marginTop:"8px"},children:"➕ Добавить действие"})]})},ur=()=>{const{project:t,selectedWidgetIds:o,updateWidget:s}=U();if(!t)return null;const r=o.length===1?t.widgets.find(n=>n.id===o[0]):null,h=(n,c)=>{r&&s(r.id,{[n]:c})},a=(n,c)=>{r&&s(r.id,{properties:{...r.properties,[n]:c}})};return r?e.jsxs("div",{className:"properties-panel panel",children:[e.jsxs("div",{className:"properties-header",children:[e.jsx("h3",{children:"Свойства"}),e.jsx("span",{className:"widget-type-badge",children:r.type})]}),e.jsxs("div",{className:"properties-content",children:[e.jsxs("div",{className:"property-section",children:[e.jsx("h4",{children:"Позиция и размер"}),e.jsxs("div",{className:"property-row",children:[e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"X"}),e.jsx("input",{type:"number",value:Math.round(r.x),onChange:n=>h("x",parseFloat(n.target.value))})]}),e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"Y"}),e.jsx("input",{type:"number",value:Math.round(r.y),onChange:n=>h("y",parseFloat(n.target.value))})]})]}),e.jsxs("div",{className:"property-row",children:[e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"Ширина"}),e.jsx("input",{type:"number",value:Math.round(r.width),onChange:n=>h("width",parseFloat(n.target.value)),min:1})]}),e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"Высота"}),e.jsx("input",{type:"number",value:Math.round(r.height),onChange:n=>h("height",parseFloat(n.target.value)),min:1})]})]}),e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"Поворот (градусы)"}),e.jsx("input",{type:"number",value:Math.round(r.rotation||0),onChange:n=>h("rotation",parseFloat(n.target.value))})]}),e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"Z-Index (порядок)"}),e.jsx("input",{type:"number",min:"0",value:r.zIndex||0,onChange:n=>h("zIndex",Math.max(0,parseInt(n.target.value)||0))}),e.jsxs("div",{style:{marginTop:"8px",display:"flex",gap:"4px"},children:[e.jsx("button",{className:"btn-secondary",onClick:()=>{},style:{flex:1,fontSize:"11px",padding:"4px"},title:"На передний план",children:"⬆️ Наверх"}),e.jsx("button",{className:"btn-secondary",onClick:()=>{},style:{flex:1,fontSize:"11px",padding:"4px"},title:"На задний план",children:"⬇️ Вниз"})]})]}),e.jsxs("div",{className:"property-field",style:{marginTop:"12px"},children:[e.jsx("button",{className:r.locked?"btn-danger":"btn-secondary",onClick:()=>{},style:{width:"100%"},children:r.locked?"🔒 Разблокировать":"🔓 Заблокировать"}),r.locked&&e.jsx("div",{style:{fontSize:"11px",color:"#888",marginTop:"4px"},children:"Заблокированный виджет нельзя перемещать и изменять размер"})]})]}),e.jsxs("div",{className:"property-section",children:[e.jsx("h4",{children:"Параметры виджета"}),r.type==="shape"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"Тип фигуры"}),e.jsxs("select",{value:r.properties.shapeType||"rectangle",onChange:n=>a("shapeType",n.target.value),children:[e.jsx("option",{value:"rectangle",children:"Прямоугольник"}),e.jsx("option",{value:"circle",children:"Круг"}),e.jsx("option",{value:"ellipse",children:"Эллипс"}),e.jsx("option",{value:"triangle",children:"Треугольник"}),e.jsx("option",{value:"pentagon",children:"Пятиугольник"}),e.jsx("option",{value:"hexagon",children:"Шестиугольник"}),e.jsx("option",{value:"star",children:"Звезда"}),e.jsx("option",{value:"diamond",children:"Ромб"}),e.jsx("option",{value:"line",children:"Линия"}),e.jsx("option",{value:"arrow",children:"Стрелка"})]})]}),e.jsx("h4",{style:{marginTop:"16px",marginBottom:"8px",fontSize:"12px"},children:"Заливка"}),e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"Цвет заливки"}),e.jsx("input",{type:"color",value:r.properties.fillColor||"#4a90e2",onChange:n=>a("fillColor",n.target.value)})]}),e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"Прозрачность"}),e.jsx("input",{type:"range",value:(r.properties.opacity||1)*100,onChange:n=>a("opacity",parseInt(n.target.value)/100),min:0,max:100}),e.jsxs("span",{style:{fontSize:"11px",color:"#888"},children:[Math.round((r.properties.opacity||1)*100),"%"]})]}),e.jsx("h4",{style:{marginTop:"16px",marginBottom:"8px",fontSize:"12px"},children:"Контур"}),e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"Толщина контура"}),e.jsx("input",{type:"number",value:r.properties.strokeWidth||0,onChange:n=>a("strokeWidth",parseInt(n.target.value)),min:0,max:20})]}),r.properties.strokeWidth>0&&e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"Цвет контура"}),e.jsx("input",{type:"color",value:r.properties.strokeColor||"#2c3e50",onChange:n=>a("strokeColor",n.target.value)})]}),r.properties.shapeType==="rectangle"&&e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"Скругление углов"}),e.jsx("input",{type:"number",value:r.properties.cornerRadius||0,onChange:n=>a("cornerRadius",parseInt(n.target.value)),min:0,max:100})]})]}),r.type==="button"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"Стиль кнопки"}),e.jsxs("select",{onChange:n=>{const c=n.target.value;c!=="custom"&&ze(async()=>{const{buttonStyles:i}=await import("./buttonStyles-VsZJSFTR.js");return{buttonStyles:i}},[]).then(({buttonStyles:i})=>{const l=i.find(p=>p.name===c);l&&s(r.id,{properties:{...r.properties,...l.properties}})})},children:[e.jsx("option",{value:"custom",children:"Пользовательский"}),e.jsx("option",{value:"По умолчанию",children:"По умолчанию"}),e.jsx("option",{value:"Основная",children:"Основная (синяя с тенью)"}),e.jsx("option",{value:"Успех",children:"Успех (зелёная)"}),e.jsx("option",{value:"Опасность",children:"Опасность (красная)"}),e.jsx("option",{value:"Контурная",children:"Контурная"}),e.jsx("option",{value:"Призрак",children:"Призрак"}),e.jsx("option",{value:"Градиент",children:"Градиент"}),e.jsx("option",{value:"Минимализм",children:"Минимализм"}),e.jsx("option",{value:"Неон",children:"Неон"}),e.jsx("option",{value:"Классика",children:"Классика"})]})]}),e.jsx("h4",{style:{marginTop:"16px",marginBottom:"8px",fontSize:"12px"},children:"Текст"}),e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"Текст кнопки"}),e.jsx("input",{type:"text",value:r.properties.text||"Button",onChange:n=>a("text",n.target.value)})]}),e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"Размер шрифта"}),e.jsx("input",{type:"number",value:r.properties.fontSize||16,onChange:n=>a("fontSize",parseInt(n.target.value)),min:8,max:72})]}),e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"Шрифт"}),e.jsxs("select",{value:r.properties.fontFamily||"Arial",onChange:n=>a("fontFamily",n.target.value),children:[e.jsx("option",{value:"Arial",children:"Arial"}),e.jsx("option",{value:"Helvetica",children:"Helvetica"}),e.jsx("option",{value:"Times New Roman",children:"Times New Roman"}),e.jsx("option",{value:"Courier New",children:"Courier New"}),e.jsx("option",{value:"Verdana",children:"Verdana"}),e.jsx("option",{value:"Georgia",children:"Georgia"})]})]}),e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"Начертание"}),e.jsxs("select",{value:r.properties.fontWeight||"normal",onChange:n=>a("fontWeight",n.target.value),children:[e.jsx("option",{value:"normal",children:"Обычный"}),e.jsx("option",{value:"bold",children:"Жирный"})]})]}),e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"Выравнивание"}),e.jsxs("select",{value:r.properties.textAlign||"center",onChange:n=>a("textAlign",n.target.value),children:[e.jsx("option",{value:"left",children:"По левому краю"}),e.jsx("option",{value:"center",children:"По центру"}),e.jsx("option",{value:"right",children:"По правому краю"})]})]}),e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"Цвет текста"}),e.jsx("input",{type:"color",value:r.properties.textColor||"#ffffff",onChange:n=>a("textColor",n.target.value)})]}),e.jsx("h4",{style:{marginTop:"16px",marginBottom:"8px",fontSize:"12px"},children:"Фон"}),e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"Цвет фона"}),e.jsx("input",{type:"color",value:r.properties.backgroundColor||"#2ecc71",onChange:n=>a("backgroundColor",n.target.value)})]}),e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"Скругление углов"}),e.jsx("input",{type:"number",value:r.properties.borderRadius||8,onChange:n=>a("borderRadius",parseInt(n.target.value)),min:0,max:50})]}),e.jsx("h4",{style:{marginTop:"16px",marginBottom:"8px",fontSize:"12px"},children:"Рамка"}),e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"Толщина рамки"}),e.jsx("input",{type:"number",value:r.properties.borderWidth||0,onChange:n=>a("borderWidth",parseInt(n.target.value)),min:0,max:10})]}),r.properties.borderWidth>0&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"Цвет рамки"}),e.jsx("input",{type:"color",value:r.properties.borderColor||"#000000",onChange:n=>a("borderColor",n.target.value)})]}),e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"Стиль рамки"}),e.jsxs("select",{value:r.properties.borderStyle||"solid",onChange:n=>a("borderStyle",n.target.value),children:[e.jsx("option",{value:"solid",children:"Сплошная"}),e.jsx("option",{value:"dashed",children:"Штриховая"}),e.jsx("option",{value:"dotted",children:"Пунктирная"})]})]})]}),e.jsx("h4",{style:{marginTop:"16px",marginBottom:"8px",fontSize:"12px"},children:"Тень"}),e.jsx("div",{className:"property-field",children:e.jsxs("label",{children:[e.jsx("input",{type:"checkbox",checked:r.properties.shadowEnabled||!1,onChange:n=>a("shadowEnabled",n.target.checked)}),"Включить тень"]})}),r.properties.shadowEnabled&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"Цвет тени"}),e.jsx("input",{type:"color",value:r.properties.shadowColor||"#000000",onChange:n=>a("shadowColor",n.target.value)})]}),e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"Размытие"}),e.jsx("input",{type:"number",value:r.properties.shadowBlur||10,onChange:n=>a("shadowBlur",parseInt(n.target.value)),min:0,max:50})]}),e.jsxs("div",{className:"property-row",children:[e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"Смещение X"}),e.jsx("input",{type:"number",value:r.properties.shadowOffsetX||0,onChange:n=>a("shadowOffsetX",parseInt(n.target.value)),min:-50,max:50})]}),e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"Смещение Y"}),e.jsx("input",{type:"number",value:r.properties.shadowOffsetY||4,onChange:n=>a("shadowOffsetY",parseInt(n.target.value)),min:-50,max:50})]})]}),e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"Прозрачность"}),e.jsx("input",{type:"range",value:(r.properties.shadowOpacity||.3)*100,onChange:n=>a("shadowOpacity",parseInt(n.target.value)/100),min:0,max:100}),e.jsxs("span",{style:{fontSize:"11px",color:"#888"},children:[Math.round((r.properties.shadowOpacity||.3)*100),"%"]})]})]}),e.jsx("h4",{style:{marginTop:"16px",marginBottom:"8px",fontSize:"12px"},children:"Действия"}),e.jsx(We,{widget:r,onUpdate:n=>{s(r.id,{properties:{...r.properties,actions:n}})},allWidgets:t.widgets})]}),r.type==="text"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"Текст"}),e.jsx("textarea",{value:r.properties.text||"Text",onChange:n=>a("text",n.target.value),rows:6})]}),e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"Загрузить текстовый файл"}),e.jsx("input",{type:"file",accept:".txt,.pdf,.odt,.docx",onChange:async n=>{const c=n.target.files?.[0];if(c)try{const{extractTextFromFile:i,loadRequiredLibraries:l}=await ze(async()=>{const{extractTextFromFile:x,loadRequiredLibraries:m}=await import("./fileTextExtractor-HZqzU4jo.js");return{extractTextFromFile:x,loadRequiredLibraries:m}},[]);l(),a("text","Загрузка файла...");const p=await i(c);s(r.id,{properties:{...r.properties,text:p,sourceFile:c.name}})}catch(i){console.error("Error loading file:",i),alert(`Ошибка: ${i instanceof Error?i.message:"Не удалось загрузить файл"}`),a("text","Text")}n.target.value=""}}),e.jsx("div",{style:{fontSize:"11px",color:"#888",marginTop:"4px"},children:"Поддерживаются: TXT, PDF, ODT, DOCX"}),r.properties.sourceFile&&e.jsxs("div",{style:{fontSize:"11px",color:"#888",marginTop:"4px"},children:["📄 ",r.properties.sourceFile]})]}),e.jsx("h4",{style:{marginTop:"16px",marginBottom:"8px",fontSize:"12px"},children:"Шрифт"}),e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"Размер шрифта"}),e.jsx("input",{type:"number",value:r.properties.fontSize||16,onChange:n=>a("fontSize",parseInt(n.target.value)),min:8,max:144})]}),e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"Семейство шрифта"}),e.jsxs("select",{value:r.properties.fontFamily||"Arial",onChange:n=>a("fontFamily",n.target.value),children:[e.jsx("option",{value:"Arial",children:"Arial"}),e.jsx("option",{value:"Helvetica",children:"Helvetica"}),e.jsx("option",{value:"Times New Roman",children:"Times New Roman"}),e.jsx("option",{value:"Courier New",children:"Courier New"}),e.jsx("option",{value:"Verdana",children:"Verdana"}),e.jsx("option",{value:"Georgia",children:"Georgia"}),e.jsx("option",{value:"Comic Sans MS",children:"Comic Sans MS"}),e.jsx("option",{value:"Impact",children:"Impact"})]})]}),e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"Начертание"}),e.jsxs("select",{value:r.properties.fontWeight||"normal",onChange:n=>a("fontWeight",n.target.value),children:[e.jsx("option",{value:"normal",children:"Обычный"}),e.jsx("option",{value:"bold",children:"Жирный"})]})]}),e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"Стиль"}),e.jsxs("select",{value:r.properties.fontStyle||"normal",onChange:n=>a("fontStyle",n.target.value),children:[e.jsx("option",{value:"normal",children:"Обычный"}),e.jsx("option",{value:"italic",children:"Курсив"})]})]}),e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"Декорация"}),e.jsxs("select",{value:r.properties.textDecoration||"none",onChange:n=>a("textDecoration",n.target.value),children:[e.jsx("option",{value:"none",children:"Нет"}),e.jsx("option",{value:"underline",children:"Подчёркнутый"}),e.jsx("option",{value:"line-through",children:"Зачёркнутый"})]})]}),e.jsx("h4",{style:{marginTop:"16px",marginBottom:"8px",fontSize:"12px"},children:"Выравнивание"}),e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"По горизонтали"}),e.jsxs("select",{value:r.properties.textAlign||"left",onChange:n=>a("textAlign",n.target.value),children:[e.jsx("option",{value:"left",children:"По левому краю"}),e.jsx("option",{value:"center",children:"По центру"}),e.jsx("option",{value:"right",children:"По правому краю"})]})]}),e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"По вертикали"}),e.jsxs("select",{value:r.properties.verticalAlign||"top",onChange:n=>a("verticalAlign",n.target.value),children:[e.jsx("option",{value:"top",children:"Сверху"}),e.jsx("option",{value:"middle",children:"По центру"}),e.jsx("option",{value:"bottom",children:"Снизу"})]})]}),e.jsx("h4",{style:{marginTop:"16px",marginBottom:"8px",fontSize:"12px"},children:"Цвета и фон"}),e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"Цвет текста"}),e.jsx("input",{type:"color",value:r.properties.textColor||"#000000",onChange:n=>a("textColor",n.target.value)})]}),e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"Цвет фона"}),e.jsx("input",{type:"color",value:r.properties.backgroundColor||"#ffffff",onChange:n=>a("backgroundColor",n.target.value)}),e.jsxs("label",{style:{marginTop:"4px",fontSize:"11px"},children:[e.jsx("input",{type:"checkbox",checked:r.properties.backgroundColor==="transparent",onChange:n=>a("backgroundColor",n.target.checked?"transparent":"#ffffff")}),"Прозрачный фон"]})]}),e.jsx("h4",{style:{marginTop:"16px",marginBottom:"8px",fontSize:"12px"},children:"Дополнительно"}),e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"Межстрочный интервал"}),e.jsx("input",{type:"number",value:r.properties.lineHeight||1.2,onChange:n=>a("lineHeight",parseFloat(n.target.value)),min:.5,max:3,step:.1})]}),e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"Отступ от края"}),e.jsx("input",{type:"number",value:r.properties.padding||8,onChange:n=>a("padding",parseInt(n.target.value)),min:0,max:50})]})]}),r.type==="image"&&e.jsxs(e.Fragment,{children:[e.jsx("h4",{style:{marginTop:"0",marginBottom:"12px",fontSize:"13px",fontWeight:"bold"},children:"Режим"}),e.jsx("div",{className:"property-field",children:e.jsxs("label",{children:[e.jsx("input",{type:"radio",name:"imageMode",checked:!r.properties.galleryMode,onChange:()=>a("galleryMode",!1)})," ","Одиночное изображение"]})}),e.jsx("div",{className:"property-field",children:e.jsxs("label",{children:[e.jsx("input",{type:"radio",name:"imageMode",checked:r.properties.galleryMode||!1,onChange:()=>{a("galleryMode",!0),r.properties.sources||a("sources",[])}})," ","Галерея изображений"]})}),!r.properties.galleryMode&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"URL изображения"}),e.jsx("input",{type:"text",value:r.properties.src||"",onChange:n=>a("src",n.target.value),placeholder:"https://example.com/image.jpg"})]}),e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"Загрузить файл"}),e.jsx("input",{type:"file",accept:"image/*",onChange:n=>{const c=n.target.files?.[0];if(c){const i=new FileReader;i.onload=l=>{const p=l.target?.result;p&&s(r.id,{properties:{...r.properties,src:p,isLocalFile:!0,fileName:c.name}})},i.readAsDataURL(c)}n.target.value=""}}),r.properties.isLocalFile&&r.properties.fileName&&e.jsxs("div",{style:{fontSize:"11px",color:"#888",marginTop:"4px"},children:["📁 ",r.properties.fileName]})]})]}),r.properties.galleryMode&&e.jsxs(e.Fragment,{children:[e.jsx("h4",{style:{marginTop:"16px",marginBottom:"8px",fontSize:"12px"},children:"Источники (макс. 50)"}),e.jsxs("div",{style:{maxHeight:"200px",overflowY:"auto",border:"1px solid #ddd",borderRadius:"4px",padding:"8px",marginBottom:"8px",backgroundColor:"#fafafa"},children:[(r.properties.sources||[]).map((n,c)=>e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px",marginBottom:"6px",padding:"6px",backgroundColor:"#fff",borderRadius:"4px",border:"1px solid #e0e0e0"},children:[e.jsxs("span",{style:{fontSize:"11px",color:"#666",minWidth:"20px"},children:[c+1,"."]}),e.jsx("span",{style:{fontSize:"11px",color:n.type==="url"?"#007acc":"#2ecc71"},children:n.type==="url"?"🌐":"📷"}),e.jsx("span",{style:{flex:1,fontSize:"11px",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:n.value.length>40?n.value.substring(0,40)+"...":n.value}),e.jsx("button",{onClick:()=>{const i=(r.properties.sources||[]).filter((l,p)=>p!==c);a("sources",i)},style:{padding:"2px 6px",fontSize:"10px",border:"none",background:"#e74c3c",color:"#fff",borderRadius:"3px",cursor:"pointer"},children:"✕"})]},n.id)),(!r.properties.sources||r.properties.sources.length===0)&&e.jsx("div",{style:{textAlign:"center",color:"#999",fontSize:"11px",padding:"20px"},children:"Нет изображений в галерее"})]}),e.jsxs("div",{style:{display:"flex",gap:"8px",marginBottom:"8px"},children:[e.jsx("input",{type:"file",accept:"image/*",multiple:!0,id:`gallery-upload-${r.id}`,style:{display:"none"},onChange:n=>{const c=Array.from(n.target.files||[]),i=r.properties.sources||[];if(i.length+c.length>50){alert("Максимум 50 изображений в галерее"),n.target.value="";return}let l=0;const p=[];c.forEach(x=>{const m=new FileReader;m.onload=g=>{const b=g.target?.result;b&&p.push({id:`img-${Date.now()}-${Math.random()}`,type:"local",value:b}),l++,l===c.length&&a("sources",[...i,...p])},m.readAsDataURL(x)}),n.target.value=""}}),e.jsx("button",{onClick:()=>{document.getElementById(`gallery-upload-${r.id}`)?.click()},className:"btn-secondary",style:{flex:1,fontSize:"11px",padding:"6px"},children:"📷 Добавить файлы"}),e.jsx("button",{onClick:()=>{const n=prompt("Введите URL изображения:");if(n){const c=r.properties.sources||[];if(c.length>=50){alert("Максимум 50 изображений в галерее");return}a("sources",[...c,{id:`img-${Date.now()}-${Math.random()}`,type:"url",value:n}])}},className:"btn-secondary",style:{flex:1,fontSize:"11px",padding:"6px"},children:"🌐 Добавить URL"})]}),e.jsx("h4",{style:{marginTop:"16px",marginBottom:"8px",fontSize:"12px"},children:"Автопереключение"}),e.jsx("div",{className:"property-field",children:e.jsxs("label",{children:[e.jsx("input",{type:"checkbox",checked:r.properties.autoSwitch||!1,onChange:n=>a("autoSwitch",n.target.checked)})," ","Включить автопереключение"]})}),r.properties.autoSwitch&&e.jsx(e.Fragment,{children:e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"Интервал (секунды)"}),e.jsx("input",{type:"number",min:"1",max:"60",value:r.properties.switchInterval||3,onChange:n=>a("switchInterval",parseInt(n.target.value)||3)})]})}),e.jsx("h4",{style:{marginTop:"16px",marginBottom:"8px",fontSize:"12px"},children:"Эффекты перехода"}),e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"Эффект"}),e.jsxs("select",{value:r.properties.transition||"fade",onChange:n=>a("transition",n.target.value),children:[e.jsx("option",{value:"none",children:"Нет (мгновенно)"}),e.jsx("option",{value:"fade",children:"Затухание"}),e.jsx("option",{value:"slide",children:"Скольжение"}),e.jsx("option",{value:"zoom",children:"Увеличение"})]})]}),e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"Длительность (мс)"}),e.jsx("input",{type:"number",min:"100",max:"2000",step:"100",value:r.properties.transitionDuration||500,onChange:n=>a("transitionDuration",parseInt(n.target.value)||500)})]}),e.jsx("h4",{style:{marginTop:"16px",marginBottom:"8px",fontSize:"12px"},children:"Контролы"}),e.jsx("div",{className:"property-field",children:e.jsxs("label",{children:[e.jsx("input",{type:"checkbox",checked:r.properties.showControls!==!1,onChange:n=>a("showControls",n.target.checked)})," ","Показать стрелки"]})}),e.jsx("div",{className:"property-field",children:e.jsxs("label",{children:[e.jsx("input",{type:"checkbox",checked:r.properties.showIndicators!==!1,onChange:n=>a("showIndicators",n.target.checked)})," ","Показать индикаторы"]})}),e.jsx("div",{className:"property-field",children:e.jsxs("label",{children:[e.jsx("input",{type:"checkbox",checked:r.properties.loop!==!1,onChange:n=>a("loop",n.target.checked)})," ","Зацикливание"]})})]}),e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"Тип заполнения"}),e.jsxs("select",{value:r.properties.objectFit||"contain",onChange:n=>a("objectFit",n.target.value),children:[e.jsx("option",{value:"contain",children:"Пропорционально (вписать)"}),e.jsx("option",{value:"cover",children:"Заполнить весь виджет"}),e.jsx("option",{value:"fill",children:"Растянуть"}),e.jsx("option",{value:"scale-down",children:"Оригинальный размер"}),e.jsx("option",{value:"adaptive",children:"Адаптивный (изменить виджет)"})]})]}),e.jsx("h4",{style:{marginTop:"16px",marginBottom:"8px",fontSize:"12px"},children:"Форма обрезки"}),e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"Форма"}),e.jsxs("select",{value:r.properties.clipShape||"rectangle",onChange:n=>a("clipShape",n.target.value),children:[e.jsx("option",{value:"rectangle",children:"⬜ Прямоугольник"}),e.jsx("option",{value:"circle",children:"⚫ Круг"}),e.jsx("option",{value:"ellipse",children:"🔴 Эллипс"}),e.jsx("option",{value:"triangle",children:"🔺 Треугольник"}),e.jsx("option",{value:"diamond",children:"🔶 Ромб"}),e.jsx("option",{value:"pentagon",children:"⬢ Пятиугольник"}),e.jsx("option",{value:"hexagon",children:"⬡ Шестиугольник"}),e.jsx("option",{value:"octagon",children:"⭐ Восьмиугольник"}),e.jsx("option",{value:"rounded-rectangle",children:"🏷️ Закругленный прямоугольник"})]})]}),r.properties.clipShape==="rounded-rectangle"&&e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"Радиус углов (px)"}),e.jsx("input",{type:"number",min:"0",max:"100",value:r.properties.cornerRadius||20,onChange:n=>a("cornerRadius",parseInt(n.target.value)||20)})]}),e.jsx("h4",{style:{marginTop:"16px",marginBottom:"8px",fontSize:"12px"},children:"Рамка"}),e.jsx("div",{className:"property-field",children:e.jsxs("label",{children:[e.jsx("input",{type:"checkbox",checked:r.properties.borderEnabled||!1,onChange:n=>a("borderEnabled",n.target.checked)}),"Включить рамку"]})}),r.properties.borderEnabled&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"Тип рамки"}),e.jsxs("select",{value:r.properties.borderStyle||"solid",onChange:n=>a("borderStyle",n.target.value),children:[e.jsx("option",{value:"solid",children:"Сплошная"}),e.jsx("option",{value:"dashed",children:"Штриховая"}),e.jsx("option",{value:"dotted",children:"Пунктирная"}),e.jsx("option",{value:"double",children:"Двойная"})]})]}),e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"Толщина рамки (px)"}),e.jsx("input",{type:"number",value:r.properties.borderWidth||2,onChange:n=>a("borderWidth",parseFloat(n.target.value)),min:1,max:20})]}),e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"Цвет рамки"}),e.jsx("input",{type:"color",value:r.properties.borderColor||"#000000",onChange:n=>a("borderColor",n.target.value)})]})]})]}),r.type==="video"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"Тип источника"}),e.jsxs("select",{value:r.properties.sourceType||"url",onChange:n=>a("sourceType",n.target.value),children:[e.jsx("option",{value:"url",children:"URL / Файл"}),e.jsx("option",{value:"rtsp",children:"RTSP поток"})]})]}),r.properties.sourceType==="rtsp"?e.jsx(e.Fragment,{children:e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"RTSP URL"}),e.jsx("input",{type:"text",value:r.properties.rtspUrl||"",onChange:n=>a("rtspUrl",n.target.value),placeholder:"rtsp://username:password@host:554/stream"}),e.jsx("div",{style:{fontSize:"11px",color:"#888",marginTop:"4px"},children:"Пример: rtsp://admin:12345@192.168.1.100:554/live"})]})}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"URL видео"}),e.jsx("input",{type:"text",value:r.properties.src||"",onChange:n=>a("src",n.target.value),placeholder:"https://example.com/video.mp4"})]}),e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"Загрузить файл"}),e.jsx("input",{type:"file",accept:"video/*",onChange:async n=>{const c=n.target.files?.[0];if(c){if(c.size>524288e3){alert("⚠️ Файл слишком большой! Максимум 500 MB"),n.target.value="";return}try{if(console.log(`⏳ Загрузка видео (${(c.size/(1024*1024)).toFixed(1)} MB)...`),!t?.id){alert("❌ Сначала создайте или откройте проект"),n.target.value="";return}const l=await H.uploadFile(t.id,c);l&&(s(r.id,{properties:{...r.properties,src:l.url,isLocalFile:!1,fileName:c.name}}),alert("✅ Видео загружено на сервер!"))}catch(l){console.error("Upload error:",l),alert("❌ Ошибка загрузки: "+l.message)}n.target.value=""}}}),r.properties.isLocalFile&&r.properties.fileName&&e.jsxs("div",{style:{fontSize:"11px",color:"#888",marginTop:"4px"},children:["📁 ",r.properties.fileName]})]})]}),e.jsx("h4",{style:{marginTop:"16px",marginBottom:"8px",fontSize:"12px"},children:"Отображение"}),e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"Тип заполнения"}),e.jsxs("select",{value:r.properties.objectFit||"contain",onChange:n=>a("objectFit",n.target.value),children:[e.jsx("option",{value:"contain",children:"Пропорционально (вписать)"}),e.jsx("option",{value:"cover",children:"Заполнить весь виджет"}),e.jsx("option",{value:"fill",children:"Растянуть"}),e.jsx("option",{value:"scale-down",children:"Оригинальный размер"}),e.jsx("option",{value:"adaptive",children:"Адаптивный (изменить виджет)"})]})]}),e.jsx("h4",{style:{marginTop:"16px",marginBottom:"8px",fontSize:"12px"},children:"Воспроизведение"}),e.jsx("div",{className:"property-field",children:e.jsxs("label",{children:[e.jsx("input",{type:"checkbox",checked:r.properties.autoplay||!1,onChange:n=>a("autoplay",n.target.checked)}),"Автовоспроизведение"]})}),e.jsx("div",{className:"property-field",children:e.jsxs("label",{children:[e.jsx("input",{type:"checkbox",checked:r.properties.loop||!1,onChange:n=>a("loop",n.target.checked)}),"Повтор (loop)"]})}),e.jsx("div",{className:"property-field",children:e.jsxs("label",{children:[e.jsx("input",{type:"checkbox",checked:r.properties.muted!==!1,onChange:n=>a("muted",n.target.checked)}),"Без звука (muted)"]})}),e.jsx("div",{className:"property-field",children:e.jsxs("label",{children:[e.jsx("input",{type:"checkbox",checked:r.properties.controls!==!1,onChange:n=>a("controls",n.target.checked)}),"Показывать элементы управления"]})}),e.jsx("h4",{style:{marginTop:"16px",marginBottom:"8px",fontSize:"12px"},children:"Рамка"}),e.jsx("div",{className:"property-field",children:e.jsxs("label",{children:[e.jsx("input",{type:"checkbox",checked:r.properties.borderEnabled||!1,onChange:n=>a("borderEnabled",n.target.checked)}),"Включить рамку"]})}),r.properties.borderEnabled&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"Стиль рамки"}),e.jsxs("select",{value:r.properties.borderStyle||"solid",onChange:n=>a("borderStyle",n.target.value),children:[e.jsx("option",{value:"solid",children:"Сплошная"}),e.jsx("option",{value:"dashed",children:"Штриховая"}),e.jsx("option",{value:"dotted",children:"Пунктирная"}),e.jsx("option",{value:"double",children:"Двойная"})]})]}),e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"Толщина рамки"}),e.jsx("input",{type:"number",value:r.properties.borderWidth||2,onChange:n=>a("borderWidth",parseInt(n.target.value)),min:1,max:20})]}),e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"Цвет рамки"}),e.jsx("input",{type:"color",value:r.properties.borderColor||"#000000",onChange:n=>a("borderColor",n.target.value)})]})]})]}),r.type==="menu"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"Ориентация"}),e.jsxs("select",{value:r.properties.orientation||"horizontal",onChange:n=>a("orientation",n.target.value),children:[e.jsx("option",{value:"horizontal",children:"Горизонтальная"}),e.jsx("option",{value:"vertical",children:"Вертикальная"})]})]}),e.jsx("h4",{style:{marginTop:"16px",marginBottom:"8px",fontSize:"12px"},children:"Внешний вид"}),e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"Цвет фона"}),e.jsx("input",{type:"color",value:r.properties.backgroundColor||"#2c3e50",onChange:n=>a("backgroundColor",n.target.value)})]}),e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"Цвет текста"}),e.jsx("input",{type:"color",value:r.properties.textColor||"#ffffff",onChange:n=>a("textColor",n.target.value)})]}),e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"Цвет при наведении"}),e.jsx("input",{type:"color",value:r.properties.hoverColor||"#34495e",onChange:n=>a("hoverColor",n.target.value)})]}),e.jsx("h4",{style:{marginTop:"16px",marginBottom:"8px",fontSize:"12px"},children:"Шрифт"}),e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"Размер шрифта"}),e.jsx("input",{type:"number",value:r.properties.fontSize||16,onChange:n=>a("fontSize",parseInt(n.target.value)),min:10,max:32})]}),e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"Семейство шрифта"}),e.jsxs("select",{value:r.properties.fontFamily||"Arial",onChange:n=>a("fontFamily",n.target.value),children:[e.jsx("option",{value:"Arial",children:"Arial"}),e.jsx("option",{value:"Helvetica",children:"Helvetica"}),e.jsx("option",{value:"Times New Roman",children:"Times New Roman"}),e.jsx("option",{value:"Verdana",children:"Verdana"}),e.jsx("option",{value:"Georgia",children:"Georgia"})]})]}),e.jsx("h4",{style:{marginTop:"16px",marginBottom:"8px",fontSize:"12px"},children:"Размеры"}),e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"Высота пункта"}),e.jsx("input",{type:"number",value:r.properties.itemHeight||40,onChange:n=>a("itemHeight",parseInt(n.target.value)),min:30,max:100})]}),e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"Отступ пункта"}),e.jsx("input",{type:"number",value:r.properties.itemPadding||16,onChange:n=>a("itemPadding",parseInt(n.target.value)),min:8,max:40})]}),e.jsx("h4",{style:{marginTop:"16px",marginBottom:"8px",fontSize:"12px"},children:"Подменю"}),e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"Цвет фона подменю"}),e.jsx("input",{type:"color",value:r.properties.submenuBackgroundColor||"#34495e",onChange:n=>a("submenuBackgroundColor",n.target.value)})]}),e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"Цвет текста подменю"}),e.jsx("input",{type:"color",value:r.properties.submenuTextColor||"#ffffff",onChange:n=>a("submenuTextColor",n.target.value)})]}),e.jsx("h4",{style:{marginTop:"16px",marginBottom:"8px",fontSize:"12px"},children:"Рамка"}),e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"Толщина рамки"}),e.jsx("input",{type:"number",value:r.properties.borderWidth||0,onChange:n=>a("borderWidth",parseInt(n.target.value)),min:0,max:10})]}),r.properties.borderWidth>0&&e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"Цвет рамки"}),e.jsx("input",{type:"color",value:r.properties.borderColor||"#000000",onChange:n=>a("borderColor",n.target.value)})]}),e.jsx("h4",{style:{marginTop:"16px",marginBottom:"8px",fontSize:"12px"},children:"Пункты меню"}),e.jsx("div",{className:"property-field",children:e.jsx("button",{className:"btn-secondary",onClick:()=>{const n=r.properties.items||[],c={id:`item-${Date.now()}`,label:"Новый пункт"};s(r.id,{properties:{...r.properties,items:[...n,c]}})},style:{width:"100%"},children:"➕ Добавить пункт"})}),e.jsx("div",{style:{maxHeight:"300px",overflowY:"auto"},children:(r.properties.items||[]).map((n,c)=>e.jsxs("div",{style:{background:"#252525",padding:"12px",marginBottom:"8px",borderRadius:"6px",border:"1px solid #333"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"8px"},children:[e.jsxs("strong",{style:{fontSize:"12px",color:"#aaa"},children:["Пункт ",c+1]}),e.jsx("button",{className:"btn-danger",onClick:()=>{const i=r.properties.items||[];s(r.id,{properties:{...r.properties,items:i.filter(l=>l.id!==n.id)}})},style:{fontSize:"11px",padding:"4px 8px"},children:"🗑️ Удалить"})]}),e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"Название"}),e.jsx("input",{type:"text",value:n.label,onChange:i=>{const l=[...r.properties.items||[]];l[c]={...l[c],label:i.target.value},s(r.id,{properties:{...r.properties,items:l}})}})]}),e.jsxs("div",{style:{marginTop:"12px"},children:[e.jsx("div",{style:{fontSize:"11px",color:"#888",marginBottom:"8px"},children:"Действия при клике"}),e.jsx(We,{widget:{...r,id:n.id,properties:n},onUpdate:i=>{const l=[...r.properties.items||[]];l[c]={...l[c],actions:i},s(r.id,{properties:{...r.properties,items:l}})},allWidgets:t.widgets})]}),e.jsxs("div",{style:{marginTop:"12px",paddingLeft:"12px",borderLeft:"2px solid #444"},children:[e.jsx("div",{style:{fontSize:"11px",color:"#888",marginBottom:"8px"},children:"Подпункты"}),e.jsx("button",{className:"btn-secondary",onClick:()=>{const i=[...r.properties.items||[]],l=i[c].children||[];i[c]={...i[c],children:[...l,{id:`subitem-${Date.now()}`,label:"Подпункт"}]},s(r.id,{properties:{...r.properties,items:i}})},style:{width:"100%",fontSize:"11px",padding:"6px",marginBottom:"8px"},children:"➕ Добавить подпункт"}),(n.children||[]).map((i,l)=>e.jsx("div",{style:{background:"#1e1e1e",padding:"8px",marginBottom:"6px",borderRadius:"4px",border:"1px solid #2a2a2a"},children:e.jsxs("div",{style:{display:"flex",gap:"6px",alignItems:"center"},children:[e.jsx("input",{type:"text",value:i.label,onChange:p=>{const x=[...r.properties.items||[]],m=[...x[c].children||[]];m[l]={...m[l],label:p.target.value},x[c]={...x[c],children:m},s(r.id,{properties:{...r.properties,items:x}})},style:{flex:1,fontSize:"12px",padding:"4px 8px"}}),e.jsx("button",{className:"btn-danger",onClick:()=>{const p=[...r.properties.items||[]],x=p[c].children?.filter(m=>m.id!==i.id)||[];p[c]={...p[c],children:x},s(r.id,{properties:{...r.properties,items:p}})},style:{fontSize:"11px",padding:"4px 8px"},children:"🗑️"})]})},i.id))]})]},n.id))})]})]}),e.jsx("div",{className:"property-section",children:e.jsxs("div",{className:"property-field",children:[e.jsx("label",{children:"ID"}),e.jsx("input",{type:"text",value:r.id,disabled:!0,style:{opacity:.5,cursor:"not-allowed"}})]})})]})]}):e.jsxs("div",{className:"properties-panel panel",children:[e.jsx("div",{className:"properties-header",children:e.jsx("h3",{children:"Свойства"})}),e.jsx("div",{className:"properties-empty",children:e.jsx("p",{children:"Выберите виджет для редактирования"})})]})},xr=()=>{const t=Me(),[o,s]=k.useState(0),{project:r,restoreProject:h,selectedWidgetIds:a,copy:n,paste:c,cut:i,deleteWidget:l,undo:p,redo:x}=U();return k.useEffect(()=>{(async()=>{console.log("[Editor] Checking for project to restore...");const g=await h();console.log(g?"[Editor] Project restored successfully":"[Editor] No project to restore")})()},[]),k.useEffect(()=>{const m=b=>{const f=b.detail?.reason||"unknown";console.log("[Editor] Logout event received, reason:",f),f==="inactivity"&&sessionStorage.setItem("kiosk_logout_reason","inactivity"),t("/login",{replace:!0})},g=()=>{console.log("[Editor] Unauthorized event received"),sessionStorage.setItem("kiosk_logout_reason","session_expired"),t("/login",{replace:!0})};return window.addEventListener("auth:logout",m),window.addEventListener("auth:unauthorized",g),()=>{window.removeEventListener("auth:logout",m),window.removeEventListener("auth:unauthorized",g)}},[t]),k.useEffect(()=>{const m=g=>{(g.ctrlKey||g.metaKey)&&g.key==="z"&&!g.shiftKey&&(g.preventDefault(),p()),(g.ctrlKey||g.metaKey)&&g.key==="z"&&g.shiftKey&&(g.preventDefault(),x()),(g.ctrlKey||g.metaKey)&&g.key==="c"&&(g.preventDefault(),n()),(g.ctrlKey||g.metaKey)&&g.key==="v"&&(g.preventDefault(),c()),(g.ctrlKey||g.metaKey)&&g.key==="x"&&(g.preventDefault(),i()),g.key==="Delete"&&(g.preventDefault(),a.forEach(b=>l(b)))};return window.addEventListener("keydown",m),()=>window.removeEventListener("keydown",m)},[]),k.useEffect(()=>{const m=()=>{s(g=>g+1)};return window.addEventListener("auth:login",m),()=>window.removeEventListener("auth:login",m)},[]),e.jsxs("div",{className:"editor",children:[e.jsx(Rt,{}),e.jsx(Zt,{}),e.jsxs("div",{className:"editor-main",children:[e.jsx(dr,{}),e.jsx(lr,{}),e.jsx(ur,{})]})]})},fr=({children:t})=>H.isAuthenticated()?e.jsx(e.Fragment,{children:t}):(console.log("[ProtectedRoute] Not authenticated, redirecting to /login"),e.jsx(ge,{to:"/login",replace:!0})),gr=()=>(console.log("[App.tsx] App component rendering with Router"),e.jsx(Ue,{children:e.jsxs(qe,{children:[e.jsx(te,{path:"/",element:e.jsx(ge,{to:"/login",replace:!0})}),e.jsx(te,{path:"/login",element:e.jsx(Pt,{})}),e.jsx(te,{path:"/editor",element:e.jsx(fr,{children:e.jsx(xr,{})})}),e.jsx(te,{path:"*",element:e.jsx(ge,{to:"/login",replace:!0})}),e.jsx(te,{path:"/preview",element:e.jsx(Wt,{})})]})}));try{const t=document.getElementById("root");if(!t)throw new Error("Root element not found");rt.createRoot(t).render(e.jsx(V.StrictMode,{children:e.jsx(gr,{})}))}catch(t){console.error("Failed to mount React app:",t),document.body.innerHTML=`
    <div style="
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background: #1e1e1e;
      color: #ff6b6b;
      font-family: Arial, sans-serif;
      padding: 20px;
    ">
      <div style="text-align: center; max-width: 600px;">
        <h1>❌ Ошибка загрузки редактора</h1>
        <p style="color: #cccccc;">Проверьте консоль браузера (F12) для деталей.</p>
        <pre style="
          text-align: left;
          background: #2a2a2a;
          padding: 15px;
          border-radius: 5px;
          overflow-x: auto;
          color: #ff6b6b;
        ">${t}</pre>
        <button onclick="location.reload()" style="
          margin-top: 20px;
          padding: 10px 20px;
          background: #4a90e2;
          color: white;
          border: none;
          border-radius: 5px;
          cursor: pointer;
          font-size: 14px;
        ">
          Перезагрузить страницу
        </button>
      </div>
    </div>
  `}
//# sourceMappingURL=index-cbN-8qlF.js.map
