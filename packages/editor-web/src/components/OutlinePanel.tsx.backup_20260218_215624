import React from 'react';
import { useEditorStore } from '../stores/editorStore';
import { Eye, EyeOff, Lock, Unlock, Trash2 } from 'lucide-react';
import './OutlinePanel.css';

const OutlinePanel: React.FC = () => {
  const { project, selectedWidgetIds, selectWidget, updateWidget, deleteWidget } = useEditorStore();

  if (!project) return null;

  // –ü–æ–ª—É—á–∞–µ–º –∏–∫–æ–Ω–∫—É –¥–ª—è —Ç–∏–ø–∞ –≤–∏–¥–∂–µ—Ç–∞
  const getWidgetIcon = (type: string): string => {
    const icons: Record<string, string> = {
      shape: 'üî∑',
      rectangle: 'üî∑',
      text: 'üìù',
      button: 'üîò',
      image: 'üñºÔ∏è',
      video: 'üé¨',
      menu: 'üçî'
    };
    return icons[type] || '‚¨ú';
  };

  // –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –≤–∏–¥–∂–µ—Ç–∞
  const getWidgetLabel = (widget: any): string => {
    if (widget.properties.text) {
      const text = widget.properties.text.substring(0, 20);
      return text.length < widget.properties.text.length ? `${text}...` : text;
    }
    if (widget.properties.items) {
      return `–ú–µ–Ω—é (${widget.properties.items.length} –ø—É–Ω–∫—Ç–æ–≤)`;
    }
    return widget.type.charAt(0).toUpperCase() + widget.type.slice(1);
  };

  // –°–æ—Ä—Ç–∏—Ä—É–µ–º –≤–∏–¥–∂–µ—Ç—ã –ø–æ z-index
  const sortedWidgets = [...project.widgets].sort((a, b) => {
    return (b.zIndex || 0) - (a.zIndex || 0);
  });

  return (
    <div className="outline-panel">
      <div className="outline-header">
        <h3>–°—Ç—Ä—É–∫—Ç—É—Ä–∞</h3>
        <span className="outline-count">{project.widgets.length} –≤–∏–¥–∂–µ—Ç–æ–≤</span>
      </div>

      <div className="outline-list">
        {sortedWidgets.length === 0 ? (
          <div className="outline-empty">
            <p>–ù–µ—Ç –≤–∏–¥–∂–µ—Ç–æ–≤</p>
            <span>–î–æ–±–∞–≤—å—Ç–µ –≤–∏–¥–∂–µ—Ç—ã –∏–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏</span>
          </div>
        ) : (
          sortedWidgets.map((widget) => {
            const isSelected = selectedWidgetIds.includes(widget.id);
            const isLocked = widget.locked || false;
            const isVisible = widget.visible !== false;

            return (
              <div
                key={widget.id}
                className={`outline-item ${isSelected ? 'selected' : ''} ${isLocked ? 'locked' : ''} ${!isVisible ? 'invisible' : ''}`}
                onClick={() => selectWidget(widget.id, false)}
              >
                <div className="outline-item-main">
                  <span className="outline-icon">{getWidgetIcon(widget.type)}</span>
                  <div className="outline-info">
                    <span className="outline-label">{getWidgetLabel(widget)}</span>
                    <span className="outline-meta">
                      {widget.width}√ó{widget.height} ‚Ä¢ z:{widget.zIndex || 0}
                    </span>
                  </div>
                </div>

                <div className="outline-actions" onClick={(e) => e.stopPropagation()}>
                  {/* –í–∏–¥–∏–º–æ—Å—Ç—å */}
                  <button
                    className={`outline-action-btn ${!isVisible ? 'hidden-btn' : ''}`}
                    onClick={() => updateWidget(widget.id, { visible: !isVisible })}
                    title={isVisible ? '–°–∫—Ä—ã—Ç—å' : '–ü–æ–∫–∞–∑–∞—Ç—å'}
                  >
                    {isVisible ? <Eye size={14} /> : <EyeOff size={14} />}
                  </button>

                  {/* –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ */}
                  <button
                    className="outline-action-btn"
                    onClick={() => {
                      updateWidget(widget.id, { locked: !isLocked });
                    }}
                    title={isLocked ? '–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å' : '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å'}
                  >
                    {isLocked ? <Lock size={14} /> : <Unlock size={14} />}
                  </button>

                  {/* –£–¥–∞–ª–µ–Ω–∏–µ */}
                  <button
                    className="outline-action-btn delete"
                    onClick={() => {
                      if (window.confirm(`–£–¥–∞–ª–∏—Ç—å –≤–∏–¥–∂–µ—Ç "${getWidgetLabel(widget)}"?`)) {
                        deleteWidget(widget.id);
                      }
                    }}
                    title="–£–¥–∞–ª–∏—Ç—å"
                  >
                    <Trash2 size={14} />
                  </button>
                </div>
              </div>
            );
          })
        )}
      </div>
    </div>
  );
};

export default OutlinePanel;
