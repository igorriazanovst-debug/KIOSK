const { app, BrowserWindow, ipcMain, dialog } = require('electron');
const path = require('path');
const fs = require('fs');

let mainWindow = null;
let currentProject = null;

// Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð³Ð»Ð°Ð²Ð½Ð¾Ð³Ð¾ Ð¾ÐºÐ½Ð°
function createWindow() {
  mainWindow = new BrowserWindow({
    width: 1920,
    height: 1080,
    fullscreen: false,
    autoHideMenuBar: true,
    webPreferences: {
      nodeIntegration: false,
      contextIsolation: true,
      preload: path.join(__dirname, 'preload.js')
    },
    backgroundColor: '#000000'
  });

  // Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
  if (process.env.NODE_ENV === 'development') {
    mainWindow.loadURL('http://localhost:5173');
    mainWindow.webContents.openDevTools();
  } else {
    mainWindow.loadFile(path.join(__dirname, '../dist/index.html'));
  }

  // Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð²ÑÑ‚Ñ€Ð¾ÐµÐ½Ð½Ð¾Ð³Ð¾ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
  loadEmbeddedProject();

  // ÐšÐ¾Ð³Ð´Ð° renderer Ð³Ð¾Ñ‚Ð¾Ð² â€” Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð¿Ñ€Ð¾ÐµÐºÑ‚
  mainWindow.webContents.on('did-finish-load', () => {
    if (currentProject && mainWindow) {
      mainWindow.webContents.send('load-project', currentProject);
    }
  });
}

// Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð²ÑÑ‚Ñ€Ð¾ÐµÐ½Ð½Ð¾Ð³Ð¾ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð° â€” Ð¸Ñ‰ÐµÐ¼ Ð² Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¸Ñ… Ð¼ÐµÑÑ‚Ð°Ñ…
function loadEmbeddedProject() {
  const searchPaths = [
    // 1. extraResources â€” ÐºÑƒÐ´Ð° electron-builder ÐºÐ»Ð°Ð´Ñ‘Ñ‚ Ñ„Ð°Ð¹Ð»Ñ‹
    path.join(process.resourcesPath || '', 'project.json'),
    // 2. Ð ÑÐ´Ð¾Ð¼ Ñ electron/main.js (dev Ñ€ÐµÐ¶Ð¸Ð¼)
    path.join(__dirname, 'project.json'),
    // 3. Ð’ ÐºÐ¾Ñ€Ð½Ðµ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
    path.join(app.getAppPath(), 'project.json'),
    // 4. Ð’ electron/ Ð²Ð½ÑƒÑ‚Ñ€Ð¸ app
    path.join(app.getAppPath(), 'electron', 'project.json'),
    // 5. Ð ÑÐ´Ð¾Ð¼ Ñ exe (portable)
    path.join(path.dirname(app.getPath('exe')), 'project.json'),
  ];

  console.log('ðŸ” Searching for project.json...');

  for (const projectPath of searchPaths) {
    console.log(`  Checking: ${projectPath}`);
    if (fs.existsSync(projectPath)) {
      try {
        const projectData = fs.readFileSync(projectPath, 'utf-8');
        currentProject = JSON.parse(projectData);
        console.log(`âœ… Project loaded from: ${projectPath}`);
        console.log(`   Name: ${currentProject.name || 'unnamed'}`);
        console.log(`   Widgets: ${currentProject.widgets ? currentProject.widgets.length : 0}`);

        // ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð¿Ñ€Ð¾ÐµÐºÑ‚ Ð² renderer Ð¿Ñ€Ð¾Ñ†ÐµÑÑ
        if (mainWindow && mainWindow.webContents) {
          mainWindow.webContents.send('load-project', currentProject);
        }
        return;
      } catch (error) {
        console.error(`âŒ Failed to parse project from ${projectPath}:`, error.message);
      }
    }
  }

  console.warn('âš ï¸ project.json not found in any location');
}

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸ÐºÐ¸ IPC
ipcMain.handle('get-project', async () => {
  return currentProject;
});

ipcMain.handle('open-project', async () => {
  const result = await dialog.showOpenDialog(mainWindow, {
    properties: ['openFile'],
    filters: [
      { name: 'Kiosk Projects', extensions: ['json'] }
    ]
  });

  if (!result.canceled && result.filePaths.length > 0) {
    try {
      const projectData = fs.readFileSync(result.filePaths[0], 'utf-8');
      currentProject = JSON.parse(projectData);
      // Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÑÐµÐ¼ renderer
      if (mainWindow && mainWindow.webContents) {
        mainWindow.webContents.send('load-project', currentProject);
      }
      return currentProject;
    } catch (error) {
      console.error('Failed to load project:', error);
      return null;
    }
  }
  return null;
});

ipcMain.handle('toggle-fullscreen', async () => {
  if (mainWindow) {
    const isFullscreen = mainWindow.isFullScreen();
    mainWindow.setFullScreen(!isFullscreen);
    return !isFullscreen;
  }
  return false;
});

ipcMain.handle('close-app', async () => {
  app.quit();
});

// Lifecycle ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ñ
app.whenReady().then(() => {
  createWindow();

  app.on('activate', () => {
    if (BrowserWindow.getAllWindows().length === 0) {
      createWindow();
    }
  });
});

app.on('window-all-closed', () => {
  if (process.platform !== 'darwin') {
    app.quit();
  }
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° ÑÐ±Ð¾ÐµÐ²
process.on('uncaughtException', (error) => {
  console.error('Uncaught exception:', error);
});
