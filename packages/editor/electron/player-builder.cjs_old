/**
 * Player Builder - ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Player ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ñ‰Ð¸ÐºÐ°
 * 
 * Ð­Ñ‚Ð¾Ñ‚ ÑÐºÑ€Ð¸Ð¿Ñ‚:
 * 1. ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÑ‚ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ð¹ Ð¿Ñ€Ð¾ÐµÐºÑ‚ Ð² player/electron/project.json
 * 2. Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ ÑÐ±Ð¾Ñ€ÐºÑƒ Player
 * 3. Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ Ð¿ÑƒÑ‚ÑŒ Ðº Ð³Ð¾Ñ‚Ð¾Ð²Ð¾Ð¼Ñƒ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ñ‰Ð¸ÐºÑƒ
 */

const { spawn } = require('child_process');
const fs = require('fs');
const path = require('path');

class PlayerBuilder {
  constructor(options = {}) {
    this.projectData = options.projectData;
    this.onProgress = options.onProgress || (() => {});
    this.onLog = options.onLog || console.log;
    this.playerPath = options.playerPath || path.join(__dirname, '../../player');
  }

  log(message, type = 'info') {
    const timestamp = new Date().toLocaleTimeString();
    const formattedMessage = `[${timestamp}] ${message}`;
    this.onLog(formattedMessage, type);
  }

  async build() {
    try {
      this.log('ðŸš€ ÐÐ°Ñ‡Ð¸Ð½Ð°ÐµÐ¼ ÑÐ±Ð¾Ñ€ÐºÑƒ Player...', 'info');
      this.onProgress(0, 'ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐ°...');

      // Ð¨Ð°Ð³ 1: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑƒÑ‰ÐµÑÑ‚Ð²Ð¾Ð²Ð°Ð½Ð¸Ñ Ð¿Ð°Ð¿ÐºÐ¸ Player
      if (!fs.existsSync(this.playerPath)) {
        throw new Error(`Player Ð¿Ð°Ð¿ÐºÐ° Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°: ${this.playerPath}`);
      }
      this.log(`âœ“ Player Ð¿Ð°Ð¿ÐºÐ° Ð½Ð°Ð¹Ð´ÐµÐ½Ð°: ${this.playerPath}`, 'success');
      this.onProgress(10, 'ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ð°Ð¿ÐºÐ¸ Player...');

      // Ð¨Ð°Ð³ 2: ÐšÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
      await this.copyProjectToPlayer();
      this.onProgress(20, 'ÐŸÑ€Ð¾ÐµÐºÑ‚ ÑÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½...');

      // Ð¨Ð°Ð³ 3: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
      await this.checkDependencies();
      this.onProgress(30, 'Ð—Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐµÐ½Ñ‹...');

      // Ð¨Ð°Ð³ 4: Ð¡Ð±Ð¾Ñ€ÐºÐ° TypeScript Ð¸ Vite
      await this.buildPlayer();
      this.onProgress(60, 'Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°...');

      // Ð¨Ð°Ð³ 5: Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ñ‰Ð¸ÐºÐ° Electron
      await this.buildInstaller();
      this.onProgress(90, 'Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ñ‰Ð¸Ðº ÑÐ¾Ð·Ð´Ð°Ð½...');

      // Ð¨Ð°Ð³ 6: ÐŸÐ¾Ð¸ÑÐº Ð³Ð¾Ñ‚Ð¾Ð²Ð¾Ð³Ð¾ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ñ‰Ð¸ÐºÐ°
      const installerPath = await this.findInstaller();
      this.onProgress(100, 'Ð“Ð¾Ñ‚Ð¾Ð²Ð¾!');

      this.log('âœ… Ð¡Ð±Ð¾Ñ€ÐºÐ° ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°!', 'success');
      this.log(`ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ñ‰Ð¸Ðº: ${installerPath}`, 'success');

      return {
        success: true,
        installerPath: installerPath,
        size: this.getFileSize(installerPath)
      };

    } catch (error) {
      this.log(`âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: ${error.message}`, 'error');
      return {
        success: false,
        error: error.message
      };
    }
  }

  async copyProjectToPlayer() {
    this.log('ðŸ“‹ ÐšÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð° Ð² Player...', 'info');
    
    const projectPath = path.join(this.playerPath, 'electron', 'project.json');
    const projectDir = path.dirname(projectPath);

    // Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ ÐµÑÐ»Ð¸ Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚
    if (!fs.existsSync(projectDir)) {
      fs.mkdirSync(projectDir, { recursive: true });
    }

    // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð¿Ñ€Ð¾ÐµÐºÑ‚
    fs.writeFileSync(
      projectPath,
      JSON.stringify(this.projectData, null, 2),
      'utf8'
    );

    this.log(`âœ“ ÐŸÑ€Ð¾ÐµÐºÑ‚ ÑÐ¾Ñ…Ñ€Ð°Ð½Ñ‘Ð½: ${projectPath}`, 'success');
  }

  async checkDependencies() {
    this.log('ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹...', 'info');
    
    const nodeModulesPath = path.join(this.playerPath, 'node_modules');
    
    if (!fs.existsSync(nodeModulesPath)) {
      this.log('âš ï¸ node_modules Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹, ÑƒÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸...', 'warning');
      await this.runCommand('npm', ['install'], this.playerPath);
      this.log('âœ“ Ð—Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹', 'success');
    } else {
      this.log('âœ“ Ð—Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ ÑƒÐ¶Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹', 'success');
    }

    // ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° 7zip-bin Ð¸ app-builder-bin
    const requiredDeps = ['7zip-bin', 'app-builder-bin'];
    const packageJson = JSON.parse(
      fs.readFileSync(path.join(this.playerPath, 'package.json'), 'utf8')
    );
    
    const missingDeps = requiredDeps.filter(
      dep => !packageJson.devDependencies[dep]
    );

    if (missingDeps.length > 0) {
      this.log(`âš ï¸ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð´Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸: ${missingDeps.join(', ')}`, 'warning');
      await this.runCommand('npm', ['install', ...missingDeps, '--save-dev'], this.playerPath);
      this.log('âœ“ Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹', 'success');
    }
  }

  async buildPlayer() {
    this.log('ðŸ”¨ Ð¡Ð±Ð¾Ñ€ÐºÐ° Player (TypeScript + Vite)...', 'info');
    await this.runCommand('npm', ['run', 'build'], this.playerPath);
    this.log('âœ“ Ð¡Ð±Ð¾Ñ€ÐºÐ° Player Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°', 'success');
  }

  async buildInstaller() {
    this.log('ðŸ“¦ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ñ‰Ð¸ÐºÐ° Windows...', 'info');
    await this.runCommand('npm', ['run', 'electron:build:win'], this.playerPath);
    this.log('âœ“ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ñ‰Ð¸Ðº ÑÐ¾Ð·Ð´Ð°Ð½', 'success');
  }

  async findInstaller() {
    const distPath = path.join(this.playerPath, 'dist-electron');
    const files = fs.readdirSync(distPath);
    
    const installerFile = files.find(file => 
      file.endsWith('.exe') && file.includes('Setup')
    );

    if (!installerFile) {
      throw new Error('Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ñ‰Ð¸Ðº Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð² dist-electron/');
    }

    return path.join(distPath, installerFile);
  }

  getFileSize(filePath) {
    const stats = fs.statSync(filePath);
    const sizeMB = (stats.size / (1024 * 1024)).toFixed(2);
    return `${sizeMB} MB`;
  }

  runCommand(command, args, cwd) {
    return new Promise((resolve, reject) => {
      const process = spawn(command, args, {
        cwd: cwd,
        shell: true,
        stdio: 'pipe'
      });

      let output = '';
      let errorOutput = '';

      process.stdout.on('data', (data) => {
        const text = data.toString();
        output += text;
        // Ð›Ð¾Ð³Ð¸Ñ€ÑƒÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð²Ð°Ð¶Ð½Ñ‹Ðµ ÑÑ‚Ñ€Ð¾ÐºÐ¸
        if (text.includes('âœ“') || text.includes('âœ”') || text.includes('built')) {
          this.log(text.trim(), 'info');
        }
      });

      process.stderr.on('data', (data) => {
        const text = data.toString();
        errorOutput += text;
        // TypeScript warnings Ð½Ðµ ÐºÑ€Ð¸Ñ‚Ð¸Ñ‡Ð½Ñ‹
        if (!text.includes('TS') && !text.toLowerCase().includes('warning')) {
          this.log(text.trim(), 'warning');
        }
      });

      process.on('close', (code) => {
        if (code === 0) {
          resolve(output);
        } else {
          reject(new Error(`Command failed with code ${code}\n${errorOutput}`));
        }
      });

      process.on('error', (error) => {
        reject(error);
      });
    });
  }
}

module.exports = PlayerBuilder;
