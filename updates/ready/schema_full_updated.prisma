// packages/server/prisma/schema.prisma
// UPDATED: 2026-02-02 - Added Online Editor support

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// CORE MODELS - License Server
// ============================================================================

// Пользователи системы (админы и владельцы организаций)
model User {
  id             String        @id @default(uuid())
  email          String        @unique
  passwordHash   String
  role           UserRole      @default(USER)
  organizationId String?
  
  organization   Organization? @relation(fields: [organizationId], references: [id])
  ownedOrgs      Organization[] @relation("OrganizationOwner")
  auditLogs      AuditLog[]
  
  // NEW: Online Editor relations
  userProfile    UserProfile?
  projects       Project[]
  
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  
  @@index([email])
  @@map("users")
}

enum UserRole {
  ADMIN
  USER
}

// Организации (компании-клиенты)
model Organization {
  id          String    @id @default(uuid())
  name        String
  ownerUserId String
  
  owner       User      @relation("OrganizationOwner", fields: [ownerUserId], references: [id])
  users       User[]
  licenses    License[]
  
  // NEW: Online Editor relations
  projects    Project[]
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@index([ownerUserId])
  @@map("organizations")
}

// Лицензии (подписки)
model License {
  id             String         @id @default(uuid())
  licenseKey     String         @unique
  organizationId String
  plan           Plan
  status         LicenseStatus  @default(ACTIVE)
  seatsEditor    Int
  seatsPlayer    Int
  validFrom      DateTime
  validUntil     DateTime
  
  organization   Organization   @relation(fields: [organizationId], references: [id])
  devices        Device[]
  auditLogs      AuditLog[]
  
  // NEW: Online Editor relations
  projects       Project[]
  storageLimit   BigInt         @default(524288000) // 500 MB для BASIC
  
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  
  @@index([licenseKey])
  @@index([organizationId])
  @@index([status])
  @@map("licenses")
}

enum Plan {
  BASIC
  PRO
  MAX
}

enum LicenseStatus {
  ACTIVE
  SUSPENDED
  EXPIRED
  CANCELLED
}

// Устройства (активированные editor/player)
model Device {
  id            String       @id @default(uuid())
  deviceId      String       @unique // Hardware fingerprint
  licenseId     String
  appType       AppType
  deviceName    String
  osInfo        String
  status        DeviceStatus @default(ACTIVE)
  activatedAt   DateTime     @default(now())
  deactivatedAt DateTime?
  lastSeenAt    DateTime     @default(now())
  
  license       License      @relation(fields: [licenseId], references: [id])
  tokens        Token[]
  auditLogs     AuditLog[]
  
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  
  @@index([deviceId])
  @@index([licenseId])
  @@index([status])
  @@map("devices")
}

enum AppType {
  EDITOR
  PLAYER
}

enum DeviceStatus {
  ACTIVE
  DEACTIVATED
}

// JWT токены (для отзыва)
model Token {
  id        String   @id @default(uuid())
  deviceId  String
  jti       String   @unique // JWT ID
  tokenHash String   // Хэш токена для проверки
  expiresAt DateTime
  revoked   Boolean  @default(false)
  revokedAt DateTime?
  
  device    Device   @relation(fields: [deviceId], references: [id])
  
  createdAt DateTime @default(now())
  
  @@index([jti])
  @@index([deviceId])
  @@index([expiresAt])
  @@map("tokens")
}

// Audit Log (журнал действий)
model AuditLog {
  id        String   @id @default(uuid())
  action    String   // activate, deactivate, refresh, login, etc.
  userId    String?
  deviceId  String?
  licenseId String?
  details   Json?    // Дополнительная информация
  ipAddress String?
  userAgent String?
  
  user      User?    @relation(fields: [userId], references: [id])
  device    Device?  @relation(fields: [deviceId], references: [id])
  license   License? @relation(fields: [licenseId], references: [id])
  
  createdAt DateTime @default(now())
  
  @@index([userId])
  @@index([deviceId])
  @@index([licenseId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

// ============================================================================
// ONLINE EDITOR EXTENSION - Projects and Files
// Added: 2026-02-02
// ============================================================================

// Профили пользователей (настройки)
model UserProfile {
  id                    String   @id @default(uuid())
  userId                String   @unique
  
  // Настройки редактора
  autoSaveInterval      Int      @default(180) // секунды (3 минуты по умолчанию)
  theme                 String   @default("dark")
  language              String   @default("en")
  
  // Статистика
  totalProjects         Int      @default(0)
  totalStorageUsed      BigInt   @default(0) // байты
  
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  @@map("user_profiles")
}

// Проекты (киоск-контент)
model Project {
  id                    String         @id @default(uuid())
  name                  String
  description           String?
  
  // Владение
  licenseId             String
  organizationId        String
  createdByUserId       String?
  
  // Контент проекта (JSON)
  projectData           Json           // Полный JSON проекта (структура из Editor)
  
  // Настройки холста
  canvasWidth           Int            @default(1920)
  canvasHeight          Int            @default(1080)
  canvasBackground      String         @default("#1a1a1a")
  
  // Метаданные
  version               Int            @default(1)
  thumbnail             String?        // URL или base64 превью
  tags                  String[]       // Теги для поиска
  
  // Статистика
  totalFiles            Int            @default(0)
  totalStorageUsed      BigInt         @default(0) // байты
  viewCount             Int            @default(0)
  
  // Публикация
  isPublished           Boolean        @default(false)
  publishedAt           DateTime?
  
  // Связи
  license               License        @relation(fields: [licenseId], references: [id], onDelete: Cascade)
  organization          Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdByUser         User?          @relation(fields: [createdByUserId], references: [id], onDelete: SetNull)
  files                 ProjectFile[]
  
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt
  lastEditedAt          DateTime       @default(now())
  
  @@index([licenseId])
  @@index([organizationId])
  @@index([createdByUserId])
  @@index([name])
  @@index([isPublished])
  @@index([createdAt])
  @@map("projects")
}

// Файлы проектов (медиа-ресурсы)
model ProjectFile {
  id                    String       @id @default(uuid())
  projectId             String
  
  // Информация о файле
  fileName              String
  fileType              FileType
  mimeType              String
  fileSize              BigInt       // байты
  
  // Хранение
  storagePath           String       // Путь на диске: /uploads/projects/{projectId}/{fileId}.ext
  url                   String       // URL для доступа: /api/projects/{projectId}/files/{fileId}
  
  // Метаданные
  width                 Int?         // для изображений
  height                Int?         // для изображений
  duration              Int?         // для видео (секунды)
  thumbnail             String?      // превью для видео
  
  // Использование
  usageCount            Int          @default(0) // сколько раз используется в виджетах
  
  // Связи
  project               Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @updatedAt
  
  @@index([projectId])
  @@index([fileType])
  @@index([createdAt])
  @@map("project_files")
}

enum FileType {
  IMAGE
  VIDEO
  AUDIO
  DOCUMENT
  OTHER
}
